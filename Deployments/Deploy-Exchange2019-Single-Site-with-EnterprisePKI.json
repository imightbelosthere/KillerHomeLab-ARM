{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "TimeZone": {
            "type": "string",
            "defaultValue": "Eastern Standard Time",
            "allowedValues": [
                "Afghanistan Standard Time",
                "Alaskan Standard Time",
                "Aleutian Standard Time",
                "Altai Standard Time",
                "Arab Standard Time",
                "Arabian Standard Time",
                "Arabic Standard Time",
                "Argentina Standard Time",
                "Astrakhan Standard Time",
                "Atlantic Standard Time",
                "AUS Central Standard Time",
                "Aus Central W. Standard Time",
                "AUS Eastern Standard Time",
                "Azerbaijan Standard Time",
                "Azores Standard Time",
                "Bahia Standard Time",
                "Bangladesh Standard Time",
                "Belarus Standard Time",
                "Bougainville Standard Time",
                "Canada Central Standard Time",
                "Cape Verde Standard Time",
                "Caucasus Standard Time",
                "Cen. Australia Standard Time",
                "Central America Standard Time",
                "Central Asia Standard Time",
                "Central Brazilian Standard Time",
                "Central Europe Standard Time",
                "Central European Standard Time",
                "Central Pacific Standard Time",
                "Central Standard Time (Mexico)",
                "Central Standard Time",
                "Chatham Islands Standard Time",
                "China Standard Time",
                "Cuba Standard Time",
                "Dateline Standard Time",
                "E. Africa Standard Time",
                "E. Australia Standard Time",
                "E. Europe Standard Time",
                "E. South America Standard Time",
                "Easter Island Standard Time",
                "Eastern Standard Time (Mexico)",
                "Eastern Standard Time",
                "Egypt Standard Time",
                "Ekaterinburg Standard Time",
                "Fiji Standard Time",
                "FLE Standard Time",
                "Georgian Standard Time",
                "GMT Standard Time",
                "Greenland Standard Time",
                "Greenwich Standard Time",
                "GTB Standard Time",
                "Haiti Standard Time",
                "Hawaiian Standard Time",
                "India Standard Time",
                "Iran Standard Time",
                "Israel Standard Time",
                "Jordan Standard Time",
                "Kaliningrad Standard Time",
                "Korea Standard Time",
                "Libya Standard Time",
                "Line Islands Standard Time",
                "Lord Howe Standard Time",
                "Magadan Standard Time",
                "Magallanes Standard Time",
                "Marquesas Standard Time",
                "Mauritius Standard Time",
                "Middle East Standard Time",
                "Montevideo Standard Time",
                "Morocco Standard Time",
                "Mountain Standard Time (Mexico)",
                "Mountain Standard Time",
                "Myanmar Standard Time",
                "N. Central Asia Standard Time",
                "Namibia Standard Time",
                "Nepal Standard Time",
                "New Zealand Standard Time",
                "Newfoundland Standard Time",
                "Norfolk Standard Time",
                "North Asia East Standard Time",
                "North Asia Standard Time",
                "North Korea Standard Time",
                "Omsk Standard Time",
                "Pacific SA Standard Time",
                "Pacific Standard Time (Mexico)",
                "Pacific Standard Time",
                "Pakistan Standard Time",
                "Paraguay Standard Time",
                "Qyzylorda Standard Time",
                "Romance Standard Time",
                "Russia Time Zone 10",
                "Russia Time Zone 11",
                "Russia Time Zone 3",
                "Russian Standard Time",
                "SA Eastern Standard Time",
                "SA Pacific Standard Time",
                "SA Western Standard Time",
                "Saint Pierre Standard Time",
                "Sakhalin Standard Time",
                "Samoa Standard Time",
                "Sao Tome Standard Time",
                "Saratov Standard Time",
                "SE Asia Standard Time",
                "Singapore Standard Time",
                "South Africa Standard Time",
                "Sri Lanka Standard Time",
                "Sudan Standard Time",
                "Syria Standard Time",
                "Taipei Standard Time",
                "Tasmania Standard Time",
                "Tocantins Standard Time",
                "Tokyo Standard Time",
                "Tomsk Standard Time",
                "Tonga Standard Time",
                "Transbaikal Standard Time",
                "Turkey Standard Time",
                "Turks And Caicos Standard Time",
                "Ulaanbaatar Standard Time",
                "US Eastern Standard Time",
                "US Mountain Standard Time",
                "UTC",
                "UTC+12",
                "UTC+13",
                "UTC-02",
                "UTC-08",
                "UTC-09",
                "UTC-11",
                "Venezuela Standard Time",
                "Vladivostok Standard Time",
                "Volgograd Standard Time",
                "W. Australia Standard Time",
                "W. Central Africa Standard Time",
                "W. Europe Standard Time",
                "W. Mongolia Standard Time",
                "West Asia Standard Time",
                "West Bank Standard Time",
                "West Pacific Standard Time",
                "Yakutsk Standard Time"
            ],
            "metadata": {
                "description": "Time Zone"
            }
        },
        "AutoShutdownEnabled": {
            "type": "string",
            "defaultValue": "No",
            "allowedValues": [
                "Yes",
                "No"
            ],
            "metadata": {
                "description": "Enabled Auto Shutdown.  !!!If Enabled, AutoShutdownEmail MUST be added!!!!"
            }
        },
        "AutoShutdownTime": {
            "type": "string",
            "defaultValue": "2000",
            "metadata": {
                "description": "24-Hour Clock Time for Auto-Shutdown Example: 1900 = 7PM"
            }
        },
        "AutoShutdownEmail": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Auto-Shutdown notification Email Example:  user@domain.com"
            }
        },
        "ExchangeOrgName": {
            "type": "string",
            "defaultValue": "49ers",
            "metadata": {
                "description": "Enter an Exchange Organization Name"
            }
        },
        "PRECU11": {
            "type": "string",
            "defaultValue": "No",
            "allowedValues": [
                "Yes",
                "No"
            ],      
            "metadata": {
                "description": "Are you deploying Exchange 2019 a CU prior to CU11 (Example:  CU10, CU9)"
            }
        },    
        "Exchange2019ISOUrl": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Enter a valid URL that points to the Exchange 2019 CU .ISO"
            }
        },        
        "adminUsername": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "The name of the Administrator of the new VM and Domain"
            }
        },
        "adminPassword": {
            "type": "securestring",
            "metadata": {
                "description": "The password for the Administrator account of the new VM and Domain"
            }
        },
        "ToEmail": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Enter Email Address to send completed status"
            }
        },               
        "AzureUserObjectID": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Deployment Account Object ID"
            }
        },
        "WindowsServerLicenseType": {
            "type": "string",
            "defaultValue": "None",
            "allowedValues": [
                "None",
                "Windows_Server"
            ],
            "metadata": {
                "description": "Windows Server OS License Type"
            }
        },
        "WindowsClientLicenseType": {
            "type": "string",
            "defaultValue": "None",
            "allowedValues": [
                "None",
                "Windows_Client"
            ],      
            "metadata": {
                "description": "Windows Client OS License Type"
            }
        },        
        "NamingConvention": {
            "type": "string",
            "defaultValue": "khl",
            "maxLength": 4,
            "metadata": {
                "description": "VNet1 Name"
            }
        },
        "SubDNSDomain": {
            "type": "string",
            "defaultValue": "sub1.",
            "metadata": {
                "description": "Sub DNS Domain Name Example:  sub1. must include a DOT AT END"
            }
        },
        "SubDNSBaseDN": {
            "type": "string",
            "defaultValue": "DC=sub1,",
            "metadata": {
                "description": "Sub DNS Domain Name Example:  DC=sub2,DC=sub1, must include COMMA AT END"
            }
        },
        "NetBiosDomain": {
            "type": "string",
            "defaultValue": "sub1",
            "maxLength": 15,
            "metadata": {
                "description": "NetBios Domain Name should the same name as the SubDNSDomain parameter minus the COMMA AT END if the SubDNSDomain and SubDNSBaseDN parameters are used to specify a Sub DNS Naming Structure, but it should be unique if these parameters aren't used."
            }
        },
        "InternalDomain": {
            "type": "string",
            "defaultValue": "killerhomelab",
            "metadata": {
                "description": "NetBios Domain Name"
            }
        },
        "InternalTLD": {
            "type": "string",
            "defaultValue": "com",
            "allowedValues": [
                "com",
                "net",
                "org",
                "edu",
                "gov",
                "mil",
                "us",
                "tk",
                "ml",
                "local"
            ],
            "metadata": {
                "description": "Top-Level Domain Name"
            }
        },
        "ExternalDomain": {
            "type": "string",
            "defaultValue": "sub1.killerhomelab",
            "metadata": {
                "description": "External DNS Domain"
            }
        },    
        "ExternalTLD": {
            "type": "string",
            "defaultValue": "com",
            "allowedValues": [
                "com",
                "net",
                "org",
                "edu",
                "gov",
                "mil",
                "us",
                "tk",
                "ml"
            ],      
            "metadata": {
                "description": "External Top-Level Domain Name"
            }
        },        
        "vnet1ID": {
            "type": "string",
            "defaultValue": "172.16",
            "metadata": {
                "description": "VNet1 Prefix"
            }
        },
        "ReverseLookup1": {
            "type": "string",
            "defaultValue": "16.172",
            "metadata": {
                "description": "DNS Reverse Lookup Zone1 Prefix"
            }
        },                   
        "EnterpriseCAName": {
            "type": "string",
            "defaultValue": "Enterprise CA",
            "metadata": {
                "description": "Enterprise CA Name"
            }
        },
        "EnterpriseCAHashAlgorithm": {
            "type": "string",
            "defaultValue": "SHA256",
                "allowedValues": [
                "SHA256",
                "SHA1"
                ],
            "metadata": {
                "description": "Enterprise Root CA Algorithm"
            }
        },    
        "EnterpriseCAKeyLength": {
            "type": "string",
            "defaultValue": "4096",
                "allowedValues": [
                "4096",
                "2048"
                ],
            "metadata": {
                "description": "Enterprise Root CA Key Length"
            }
        },                                
        "DC1OSSku": {
            "type": "string",
            "defaultValue": "2022-Datacenter",
            "allowedValues": [
                "2022-Datacenter",
                "2019-Datacenter",
                "2016-Datacenter"
            ],
            "metadata": {
                "description": "Domain Controller1 OS Sku"
            }
        },
        "DC1OSVersion": {
            "type": "string",
            "defaultValue": "latest",
            "metadata": {
                "description": "DC1 OS Version Number (Example:  2022-Datacenter=20348.707.220505, 2019-Datacenter=17763.3131.220505, 2016-Datacenter=14393.5125.220505, 2012-R2-Datacenter=9600.20371.220504)"
            }
        },
        "DC1VMSize": {
            "type": "string",
            "defaultValue": "Standard_D2s_v3",
            "metadata": {
                "description": "Domain Controller1 VMSize"
            }
        },
        "ECAOSSku": {
            "type": "string",
            "defaultValue": "2022-Datacenter",
            "allowedValues": [
                "2022-Datacenter",
                "2019-Datacenter",
                "2016-Datacenter"
            ],
            "metadata": {
                "description": "Enterprise CA OS Sku"
            }
        },
        "ECAOSVersion": {
            "type": "string",
            "defaultValue": "latest",
            "metadata": {
                "description": "Enterprise CA OS Version Number (Example:  2022-Datacenter=20348.707.220505, 2019-Datacenter=17763.3131.220505, 2016-Datacenter=14393.5125.220505, 2012-R2-Datacenter=9600.20371.220504)"
            }
        },
        "ECAVMSize": {
            "type": "string",
            "defaultValue": "Standard_D2s_v3",
            "metadata": {
                "description": "Enterprise CA VMSize"
            }
        },                
        "OCSPOSSku": {
            "type": "string",
            "defaultValue": "2022-Datacenter",
            "allowedValues": [
                "2022-Datacenter",
                "2019-Datacenter",
                "2016-Datacenter"
            ],
            "metadata": {
                "description": "OCSP OS Sku"
            }
        },     
        "OCSPOSVersion": {
            "type": "string",
            "defaultValue": "latest",
            "metadata": {
                "description": "OCSP OS Version Number (Example:  2022-Datacenter=20348.707.220505, 2019-Datacenter=17763.3131.220505, 2016-Datacenter=14393.5125.220505, 2012-R2-Datacenter=9600.20371.220504)"
            }
        },
        "OCSPVMSize": {
            "type": "string",
            "defaultValue": "Standard_D2s_v3",
            "metadata": {
                "description": "OCSP VMSize"
            }
        }, 
        "FSOSSku": {
            "type": "string",
            "defaultValue": "2022-Datacenter",
            "allowedValues": [
                "2022-Datacenter",
                "2019-Datacenter",
                "2016-Datacenter"
            ],      
            "metadata": {
                "description": "File Serever OS Sku"
            }
        },                      
        "FSOSVersion": {
            "type": "string",
            "defaultValue": "latest",
            "metadata": {
                "description": "FS OS Version Number (Example:  2022-Datacenter=20348.707.220505, 2019-Datacenter=17763.3131.220505, 2016-Datacenter=14393.5125.220505)"
            }
        },        
        "FS1VMSize": {
            "type": "string",
            "defaultValue": "Standard_D2s_v3",
            "metadata": {
                "description": "File Share Witeness Server1 VMSize"
            }
        },         
        "EXOSSku": {
            "type": "string",
            "defaultValue": "2022-Datacenter",
            "allowedValues": [
                "2022-Datacenter",
                "2019-Datacenter"
            ],      
            "metadata": {
                "description": "Exchange Server OS Sku"
            }
        },            
        "EXOSVersion": {
            "type": "string",
            "defaultValue": "latest",
            "metadata": {
                "description": "EX1 OS Version Number (Example:  2019-Datacenter=17763.3131.220505)"
            }
        },  
        "EX1VMSize": {
            "type": "string",
            "defaultValue": "Standard_D8s_v3",
            "metadata": {
                "description": "Exchange Server1 VMSize"
            }
        },  
        "WK1OSSku": {
            "type": "string",
            "defaultValue": "Windows-11",
            "allowedValues": [
                "Windows-11",
                "Windows-10",
                "Windows-7"
            ],
            "metadata": {
                "description": "Workstation1 OS Sku"
            }
        }, 
        "WK1OSVersion": {
            "type": "string",
            "defaultValue": "latest",
            "metadata": {
                "description": "WK1 OS Version Number (Example:  Windows-11=22000.675.220507, Windows-10=19044.1706.220505, Windows-7=7601.25954.220506)"
            }
        },  
        "WK1VMSize": {
            "type": "string",
            "defaultValue": "Standard_D2s_v3",
            "metadata": {
                "description": "Workstation1 VMSize"
            }
        },                                                            
        "_artifactsLocation": {
            "type": "string",
            "metadata": {
                "description": "The location of resources, such as templates and DSC modules, that the template depends on"
            },
            "defaultValue": "https://raw.githubusercontent.com/elliottfieldsjr/KillerHomeLab-ARM/main/"
        },
        "_artifactsLocationSasToken": {
            "type": "securestring",
            "metadata": {
                "description": "Auto-generated token to access _artifactsLocation. Leave it blank unless you need to provide your own value."
            },
            "defaultValue": ""
        }
    },
    "variables": {
        "DeploymentName": "[deployment().name]",
        "Identifier": "[substring(variables('DeploymentName'), 19, 14)]",
        "KeyVaultName": "[concat('EX19S-', variables('Identifier'))]",
        "SecretName": "[concat(resourceGroup().Name,'-Password')]",
        "vnet1Name": "[concat(parameters('NamingConvention'),'-VNet1')]",
        "vnet1Prefix": "[concat(parameters('vnet1ID'),'.0.0/16')]",
        "vnet1subnet1Name": "[concat(parameters('NamingConvention'),'-VNet1-Subnet1')]",
        "vnet1subnet1Prefix": "[concat(parameters('vnet1ID'),'.1.0/24')]",
        "vnet1subnet2Name": "[concat(parameters('NamingConvention'),'-VNet1-Subnet2')]",
        "vnet1subnet2Prefix": "[concat(parameters('vnet1ID'),'.2.0/24')]",
        "vnet1GatewaysubnetPrefix": "[concat(parameters('vnet1ID'),'.0.0/24')]",
        "vnet1BastionsubnetPrefix": "[concat(parameters('vnet1ID'),'.253.0/24')]",
        "vnet1FirewallsubnetPrefix": "[concat(parameters('vnet1ID'),'.254.0/24')]",
        "dc1name": "[concat(parameters('NamingConvention'),'-dc-01')]",
        "dc1IP": "[concat(parameters('vnet1ID'),'.1.',variables('dc1lastoctet'))]",
        "dc1lastoctet": "101",
        "ecaname": "[concat(parameters('NamingConvention'),'-eca-01')]",           
        "ecaIP": "[concat(parameters('vnet1ID'),'.1.',variables('ecalastoctet'))]",            
        "ecalastoctet": "102",
        "ocspname": "[concat(parameters('NamingConvention'),'-ocsp-01')]",           
        "ocspIP": "[concat(parameters('vnet1ID'),'.1.',variables('ocsplastoctet'))]",                    
        "ocsplastoctet": "103",
        "fs1name": "[concat(parameters('NamingConvention'),'-fs-01')]",           
        "fs1IP": "[concat(parameters('vnet1ID'),'.1.',variables('fs1lastoctet'))]",  
        "fs1lastoctet": "104",                                                              
        "ex1name": "[concat(parameters('NamingConvention'),'-ex19-01')]",           
        "ex1IP": "[concat(parameters('vnet1ID'),'.1.',variables('ex1lastoctet'))]",         
        "ex1lastoctet": "110",    
        "wk1name": "[concat(parameters('NamingConvention'),'-wk-01')]",           
        "wk1IP": "[concat(parameters('vnet1ID'),'.2.',variables('wk1lastoctet'))]",        
        "wk1lastoctet": "201",        
        "ReverseLookup1": "[concat('1.',parameters('ReverseLookup1'))]",
        "ForwardLookup1": "[concat(parameters('vnet1ID'),'.1')]",
        "InternaldomainName": "[concat(parameters('SubDNSDomain'),parameters('InternalDomain'),'.',parameters('InternalTLD'))]",
        "ExternaldomainName": "[concat(parameters('ExternalDomain'),'.',parameters('ExternalTLD'))]", 
        "DNSArmTemplate": "[if(equals(variables('InternaldomainName'),concat(parameters('ExternalDomain'),'.',parameters('ExternalTLD'))), 'configdnsint.json', 'configdnsext.json')]",
        "ExchangeLicenseTerms": "[if(equals(parameters('PRECU11'),'Yes'), '/IAcceptExchangeServerLicenseTerms', '/IAcceptExchangeServerLicenseTerms_DiagnosticDataOFF')]",        
        "ExchangeSecurityGroup": "[concat(parameters('NetBiosDomain'),'\\Exchange Trusted Subsystem')]",                
        "BaseDN": "[concat(parameters('SubDNSBaseDN'),'DC=',parameters('InternalDomain'),',DC=',parameters('InternalTLD'))]",
        "SRV22OUPath": "[concat('OU=Servers2022,OU=Servers,',variables('BaseDN'))]",
        "SRV19OUPath": "[concat('OU=Servers2019,OU=Servers,',variables('BaseDN'))]",
        "SRV16OUPath": "[concat('OU=Servers2016,OU=Servers,',variables('BaseDN'))]", 
        "WIN11OUPath": "[concat('OU=Windows 11,OU=Workstations,',variables('BaseDN'))]",
        "WIN10OUPath": "[concat('OU=Windows 10,OU=Workstations,',variables('BaseDN'))]",
        "WIN7OUPath": "[concat('OU=Windows 7,OU=Workstations,',variables('BaseDN'))]",    
        "DB1Name": "[concat(parameters('NamingConvention'),'-19-db01')]",
        "DAG19Name": "[concat(parameters('NamingConvention'),'-19-dag01')]",
        "NSG1Name": "[concat(parameters('NamingConvention'),'-nsg01')]",
        "FromEmail": "[concat(parameters('adminUserName'),'@',variables('ExternaldomainName'))]",           
        "BastionHostAPIVersion": "2021-08-01",
        "DeploymentAPIVersion": "2021-04-01",
        "ExtensionsAPIVersion": "2022-03-01",
        "KeyVaultAPIVersion": "2021-11-01-preview",
        "KeyVaultSecretAPIVersion": "2021-11-01-preview",
        "NetworkInterfacesAPIVersion": "2021-08-01",
        "NetworkSecurityGroupAPIVersion": "2022-01-01",        
        "PublicDNSZoneAPIVersion": "2018-05-01",        
        "PublicIPAddressesAPIVersion": "2021-08-01",
        "SchedulesAPIVersion": "2018-09-15",
        "VirtualMachinesAPIVersion": "2022-03-01",
        "VirtualNetworkAPIVersion": "2020-11-01",
        "ExtensionsTypeHandlerVersion": "2.83",
        "DJExtensionsTypeHandlerVersion": "1.3"
    },
    "resources": [
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-Password-KeyVault-with-Secret",
            "Properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/keyvaultwithsecret.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "KeyVaultAPIVersion": {
                        "value": "[variables('KeyVaultAPIVersion')]"
                    },
                    "KeyVaultSecretAPIVersion": {
                        "value": "[variables('KeyVaultSecretAPIVersion')]"
                    },
                    "KeyVaultName": {
                        "value": "[variables('KeyVaultName')]"
                    },
                    "SecretName": {
                        "value": "[variables('SecretName')]"
                    },
                    "SecretValue": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "AzureUserObjectID": {
                        "value": "[parameters('AzureUserObjectID')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-VirtualNetwork-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/vnet.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "VirtualNetworkAPIVersion": {
                        "value": "[variables('VirtualNetworkAPIVersion')]"
                    },
                    "vnetName": {
                        "value": "[variables('vnet1Name')]"
                    },
                    "vnetprefix": {
                        "value": "[variables('vnet1Prefix')]"
                    },
                    "subnet1Name": {
                        "value": "[variables('vnet1subnet1Name')]"
                    },
                    "subnet1Prefix": {
                        "value": "[variables('vnet1subnet1Prefix')]"
                    },
                    "subnet2Name": {
                        "value": "[variables('vnet1subnet2Name')]"
                    },
                    "subnet2Prefix": {
                        "value": "[variables('vnet1subnet2Prefix')]"
                    },
                    "GatewaysubnetPrefix": {
                        "value": "[variables('vnet1GatewaysubnetPrefix')]"
                    },                    
                    "BastionsubnetPrefix": {
                        "value": "[variables('vnet1BastionsubnetPrefix')]"
                    },
                    "FirewallsubnetPrefix": {
                        "value": "[variables('vnet1FirewallsubnetPrefix')]"
                    }                    
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-BastionHost-01",
            "dependsOn": [
                "Deploy-VirtualNetwork-01"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/bastionhost.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "BastionHostAPIVersion": {
                        "value": "[variables('BastionHostAPIVersion')]"
                    },
                    "PublicIPAddressesAPIVersion": {
                        "value": "[variables('PublicIPAddressesAPIVersion')]"
                    },
                    "publicIPAddressName": {
                        "value": "[concat(variables('vnet1Name'),'-Bastion-pip')]"
                    },
                    "AllocationMethod": {
                        "value": "Static"
                    },
                    "vnetName": {
                        "value": "[variables('vnet1Name')]"
                    },
                    "subnetName": {
                        "value": "AzureBastionSubnet"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-DomainController-01",
            "dependsOn": [
                "Deploy-VirtualNetwork-01"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/1nic-2disk-vm.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "NetworkInterfacesAPIVersion": {
                        "value": "[variables('NetworkInterfacesAPIVersion')]"
                    },
                    "VirtualMachinesAPIVersion": {
                        "value": "[variables('VirtualMachinesAPIVersion')]"
                    },
                    "SchedulesAPIVersion": {
                        "value": "[variables('SchedulesAPIVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('dc1name')]"
                    },
                    "computerIP": {
                        "value": "[variables('dc1IP')]"
                    },
                    "Publisher": {
                        "value": "MicrosoftWindowsServer"
                    },
                    "Offer": {
                        "value": "WindowsServer"
                    },
                    "OSSku": {
                        "value": "[parameters('DC1OSSku')]"
                    },
                    "OSVersion": {
                        "value": "[parameters('DC1OSVersion')]"
                    },
                    "LicenseType": {
                        "value": "[parameters('WindowsServerLicenseType')]"
                    },
                    "DataDisk1Name": {
                        "value": "NTDS"
                    },
                    "VMSize": {
                        "value": "[parameters('DC1VMSize')]"
                    },
                    "vnetName": {
                        "value": "[variables('vnet1Name')]"
                    },
                    "subnet1Name": {
                        "value": "[variables('vnet1subnet1Name')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "TimeZone": {
                        "value": "[parameters('TimeZone')]"
                    },
                    "AutoShutdownEnabled": {
                        "value": "[parameters('AutoShutdownEnabled')]"
                    },
                    "AutoShutdownTime": {
                        "value": "[parameters('AutoShutdownTime')]"
                    },
                    "AutoShutdownEmail": {
                        "value": "[parameters('AutoShutdownEmail')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Promote-DomainController-01",
            "dependsOn": [
                "Deploy-DomainController-01"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/firstdc.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('dc1name')]"
                    },
                    "DomainName": {
                        "value": "[variables('InternaldomainName')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Update-VNet1-DNS",
            "dependsOn": [
                "Promote-DomainController-01"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/updatevnetdns.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "VirtualNetworkAPIVersion": {
                        "value": "[variables('VirtualNetworkAPIVersion')]"
                    },
                    "vnetName": {
                        "value": "[variables('vnet1Name')]"
                    },
                    "vnetprefix": {
                        "value": "[variables('vnet1Prefix')]"
                    },
                    "subnet1Name": {
                        "value": "[variables('vnet1subnet1Name')]"
                    },
                    "subnet1Prefix": {
                        "value": "[variables('vnet1subnet1Prefix')]"
                    },
                    "subnet2Name": {
                        "value": "[variables('vnet1subnet2Name')]"
                    },
                    "subnet2Prefix": {
                        "value": "[variables('vnet1subnet2Prefix')]"
                    },
                    "GatewaysubnetPrefix": {
                        "value": "[variables('vnet1GatewaysubnetPrefix')]"
                    },                    
                    "BastionsubnetPrefix": {
                        "value": "[variables('vnet1BastionsubnetPrefix')]"
                    },
                    "FirewallsubnetPrefix": {
                        "value": "[variables('vnet1FirewallsubnetPrefix')]"
                    },
                    "DNSServerIP": {
                        "value": [
                            "[variables('dc1IP')]"
                        ]
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Restart-DomainController-01_01",
            "dependsOn": [
                "Update-VNet1-DNS"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/restartvm2.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('dc1name')]"
                    },
                    "Identifier": {
                        "value": "[concat(variables('Identifier'),'-1')]"
                    },                    
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Configure-Core-DNS-Records",
            "dependsOn": [
                "Restart-DomainController-01_01"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/',variables('DNSArmTemplate'), parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('dc1name')]"
                    },
                    "InternalDomainName": {
                        "value": "[variables('InternalDomainName')]"
                    },
                    "ExternalDomainName": {
                        "value": "[variables('ExternaldomainName')]"
                    },                    
                    "ReverseLookup": {
                        "value": "[variables('ReverseLookup1')]"
                    },
                    "ForwardLookup": {
                        "value": "[variables('ForwardLookup1')]"
                    },
                    "dclastoctet": {
                        "value": "[variables('dc1lastoctet')]"
                    },
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Configure-PKI-DNS-Records",
            "dependsOn": [
                "Configure-Core-DNS-Records"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/configdnspki.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('dc1name')]"
                    },
                    "ExternalDomainName": {
                        "value": "[variables('ExternaldomainName')]"
                    },                      
                    "crlIP": {
                        "value": "[variables('ecaIP')]"
                    },                                                                                                                          
                    "ocspIP": {
                        "value": "[variables('ocspIP')]"
                    }, 
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }
                }
            }
        },        
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Configure-Exchange-DNS-Records",
            "dependsOn": [
                "Configure-PKI-DNS-Records"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/configdnsex19.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('dc1name')]"
                    },
                    "ExternalDomainName": {
                        "value": "[variables('ExternaldomainName')]"
                    },                      
                    "ex1IP": {
                        "value": "[variables('ex1IP')]"
                    },                                                                                                                          
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }
                }
            }
        },                
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Create-ActiveDirectory-OUs",
            "dependsOn": [
                "Configure-Exchange-DNS-Records"
            ],
            "properties": {
                "mode": "Incremental",
            "templateLink": {
                "uri": "[uri(parameters('_artifactsLocation'), concat('templates/createous.json', parameters('_artifactsLocationSasToken')))]",
                "contentVersion": "1.0.0.0"
            },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('dc1name')]"
                    },
                    "BaseDN": {
                        "value": "[variables('BaseDN')]"
                    },
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Create-ActiveDirectory-Site-01",
            "dependsOn": [
                "Create-ActiveDirectory-OUs"
            ],            
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/create1site.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },                    
                    "computerName": {
                        "value": "[variables('dc1name')]"
                    },
                    "NamingConvention": {
                        "value": "[parameters('NamingConvention')]"
                    },                                                                                                                          
                    "BaseDN": {
                        "value": "[variables('BaseDN')]"
                    },
                    "Site1Prefix": {
                        "value": "[variables('vnet1Prefix')]"
                    },                                                                                                                                                                                                                                                                                                           
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },                                                                                                                                                                                                                                                                                                           
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Restart-DomainController-01_02",
            "dependsOn": [
                "Create-ActiveDirectory-Site-01"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/restartvm2.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('dc1name')]"
                    },
                    "Identifier": {
                        "value": "[concat(variables('Identifier'),'-2')]"
                    },                    
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }
                }
            }
        },               
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-EnterpriseCertificateAuthority",
            "dependsOn": [
                "Create-ActiveDirectory-Site-01"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/1nic-1disk-vm.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "NetworkInterfacesAPIVersion": {
                        "value": "[variables('NetworkInterfacesAPIVersion')]"
                    },
                    "VirtualMachinesAPIVersion": {
                        "value": "[variables('VirtualMachinesAPIVersion')]"
                    },
                    "SchedulesAPIVersion": {
                        "value": "[variables('SchedulesAPIVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('ecaname')]"
                    },
                    "computerIP": {
                        "value": "[variables('ecaIP')]"
                    },
                    "Publisher": {
                        "value": "MicrosoftWindowsServer"
                    },
                    "Offer": {
                        "value": "WindowsServer"
                    },
                    "OSSku": {
                        "value": "[parameters('ECAOSSku')]"
                    },
                    "OSVersion": {
                        "value": "[parameters('ECAOSVersion')]"
                    },
                    "LicenseType": {
                        "value": "[parameters('WindowsServerLicenseType')]"
                    },
                    "VMSize": {
                        "value": "[parameters('ECAVMSize')]"
                    },
                    "vnetName": {
                        "value": "[variables('vnet1Name')]"
                    },
                    "subnet1Name": {
                        "value": "[variables('vnet1subnet1Name')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "TimeZone": {
                        "value": "[parameters('TimeZone')]"
                    },
                    "AutoShutdownEnabled": {
                        "value": "[parameters('AutoShutdownEnabled')]"
                    },
                    "AutoShutdownTime": {
                        "value": "[parameters('AutoShutdownTime')]"
                    },
                    "AutoShutdownEmail": {
                        "value": "[parameters('AutoShutdownEmail')]"
                    }
                }
            }
        },
		{
			"condition": "[equals(parameters('ECAOSSku'),'2022-Datacenter')]",
			"type": "Microsoft.Resources/deployments",
			"apiVersion": "[variables('DeploymentAPIVersion')]",
			"name": "DomainJoinEnterpriseCA-22",
			"dependsOn": [
				"Deploy-EnterpriseCertificateAuthority",
                "Restart-DomainController-01_02"
			],      
			"properties": {
				"mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/domainjoin.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
				"parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "DJExtensionsTypeHandlerVersion": {
                        "value": "[variables('DJExtensionsTypeHandlerVersion')]"
                    },                     
					"computerName": {
						"value": "[variables('ecaname')]"
					},
					"domainName": {
						"value": "[variables('InternaldomainName')]"
					},
					"OUPath": {
						"value": "[variables('SRV22OUPath')]"
					},
					"domainJoinOptions": {
						"value": 3
					},
					"adminUsername": {
						"value": "[parameters('adminUsername')]"
					},                                                                                                            
					"adminPassword": {
						"value": "[parameters('adminPassword')]"
					}
				}
			}
		},  
        {
            "condition": "[equals(parameters('ECAOSSku'),'2019-Datacenter')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "DomainJoinEnterpriseCA-19",
            "dependsOn": [
				"Deploy-EnterpriseCertificateAuthority"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/domainjoin.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "DJExtensionsTypeHandlerVersion": {
                        "value": "[variables('DJExtensionsTypeHandlerVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('ecaname')]"
                    },
                    "domainName": {
                        "value": "[variables('InternaldomainName')]"
                    },
                    "OUPath": {
                        "value": "[variables('SRV19OUPath')]"
                    },
                    "domainJoinOptions": {
                        "value": 3
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    }
                }
            }
        },	
        {
            "condition": "[equals(parameters('ECAOSSku'),'2016-Datacenter')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "DomainJoinEnterpriseCA-16",
            "dependsOn": [
				"Deploy-EnterpriseCertificateAuthority"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/domainjoin.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "DJExtensionsTypeHandlerVersion": {
                        "value": "[variables('DJExtensionsTypeHandlerVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('ecaname')]"
                    },
                    "domainName": {
                        "value": "[variables('InternaldomainName')]"
                    },
                    "OUPath": {
                        "value": "[variables('SRV16OUPath')]"
                    },
                    "domainJoinOptions": {
                        "value": 3
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Configure-EnterpriseCertificateAuthority",
            "dependsOn": [
                "DomainJoinEnterpriseCA-22",
                "DomainJoinEnterpriseCA-19",
                "DomainJoinEnterpriseCA-16"
            ],      
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/enterpriseca.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },                                         
                    "computerName": {
                        "value": "[variables('ecaname')]"
                    },                          
                    "NetBiosDomain": {
                        "value": "[parameters('NetBiosDomain')]"
                    },              
                    "domainName": {
                        "value": "[variables('ExternaldomainName')]"
                    },              
                    "EnterpriseCAName": {
                        "value": "[parameters('EnterpriseCAName')]"
                    },
                    "EnterpriseCAHashAlgorithm": {
                        "value": "[parameters('EnterpriseCAHashAlgorithm')]"
                    },  
                    "EnterpriseCAKeyLength": {
                        "value": "[parameters('EnterpriseCAKeyLength')]"
                    },     
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },                                                                                                            
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },                                                                                                            
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                }
            }
        },        				
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-OCSPServer",
            "dependsOn": [
                "Configure-EnterpriseCertificateAuthority"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/1nic-1disk-vm.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "NetworkInterfacesAPIVersion": {
                        "value": "[variables('NetworkInterfacesAPIVersion')]"
                    },
                    "VirtualMachinesAPIVersion": {
                        "value": "[variables('VirtualMachinesAPIVersion')]"
                    },
                    "SchedulesAPIVersion": {
                        "value": "[variables('SchedulesAPIVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('ocspname')]"
                    },
                    "computerIP": {
                        "value": "[variables('ocspIP')]"
                    },
                    "Publisher": {
                        "value": "MicrosoftWindowsServer"
                    },
                    "Offer": {
                        "value": "WindowsServer"
                    },
                    "OSSku": {
                        "value": "[parameters('OCSPOSSku')]"
                    },
                    "OSVersion": {
                        "value": "[parameters('OCSPOSVersion')]"
                    },
                    "LicenseType": {
                        "value": "[parameters('WindowsServerLicenseType')]"
                    },
                    "VMSize": {
                        "value": "[parameters('OCSPVMSize')]"
                    },
                    "vnetName": {
                        "value": "[variables('vnet1Name')]"
                    },
                    "subnet1Name": {
                        "value": "[variables('vnet1subnet1Name')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "TimeZone": {
                        "value": "[parameters('TimeZone')]"
                    },
                    "AutoShutdownEnabled": {
                        "value": "[parameters('AutoShutdownEnabled')]"
                    },
                    "AutoShutdownTime": {
                        "value": "[parameters('AutoShutdownTime')]"
                    },
                    "AutoShutdownEmail": {
                        "value": "[parameters('AutoShutdownEmail')]"
                    }
                }
            }
        },
		{
			"condition": "[equals(parameters('OCSPOSSku'),'2022-Datacenter')]",
			"type": "Microsoft.Resources/deployments",
			"apiVersion": "[variables('DeploymentAPIVersion')]",
			"name": "DomainJoinOCSP-22",
			"dependsOn": [
				"Deploy-OCSPServer"
			],      
			"properties": {
				"mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/domainjoin.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
				"parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "DJExtensionsTypeHandlerVersion": {
                        "value": "[variables('DJExtensionsTypeHandlerVersion')]"
                    },                    
					"computerName": {
						"value": "[variables('ocspname')]"
					},
					"domainName": {
						"value": "[variables('InternaldomainName')]"
					},
					"OUPath": {
						"value": "[variables('SRV22OUPath')]"
					},
					"domainJoinOptions": {
						"value": 3
					},
					"adminUsername": {
						"value": "[parameters('adminUsername')]"
					},                                                                                                            
					"adminPassword": {
						"value": "[parameters('adminPassword')]"
					}
				}
			}
		}, 
		{
			"condition": "[equals(parameters('OCSPOSSku'),'2019-Datacenter')]",
			"type": "Microsoft.Resources/deployments",
			"apiVersion": "[variables('DeploymentAPIVersion')]",
			"name": "DomainJoinOCSP-19",
			"dependsOn": [
				"Deploy-OCSPServer"
			],      
			"properties": {
				"mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/domainjoin.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
				"parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "DJExtensionsTypeHandlerVersion": {
                        "value": "[variables('DJExtensionsTypeHandlerVersion')]"
                    },                    
					"computerName": {
						"value": "[variables('ocspname')]"
					},
					"domainName": {
						"value": "[variables('InternaldomainName')]"
					},
					"OUPath": {
						"value": "[variables('SRV19OUPath')]"
					},
					"domainJoinOptions": {
						"value": 3
					},
					"adminUsername": {
						"value": "[parameters('adminUsername')]"
					},                                                                                                            
					"adminPassword": {
						"value": "[parameters('adminPassword')]"
					}
				}
			}
		},   
		{
			"condition": "[equals(parameters('OCSPOSSku'),'2016-Datacenter')]",
			"type": "Microsoft.Resources/deployments",
			"apiVersion": "[variables('DeploymentAPIVersion')]",
			"name": "DomainJoinOCSP-16",
			"dependsOn": [
				"Deploy-OCSPServer"
			],      
			"properties": {
				"mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/domainjoin.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
				"parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "DJExtensionsTypeHandlerVersion": {
                        "value": "[variables('DJExtensionsTypeHandlerVersion')]"
                    },                    
					"computerName": {
						"value": "[variables('ocspname')]"
					},
					"domainName": {
						"value": "[variables('InternaldomainName')]"
					},
					"OUPath": {
						"value": "[variables('SRV16OUPath')]"
					},
					"domainJoinOptions": {
						"value": 3
					},
					"adminUsername": {
						"value": "[parameters('adminUsername')]"
					},                                                                                                            
					"adminPassword": {
						"value": "[parameters('adminPassword')]"
					}
				}
			}
		},  
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Configure-OCSP",
            "dependsOn": [
                "DomainJoinOCSP-22",
                "DomainJoinOCSP-19",
                "DomainJoinOCSP-16"
            ],      
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/ocspenterprise.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },                     
                    "computerName": {
                        "value": "[variables('ocspname')]"
                    },                   
                    "NetBiosDomain": {
                        "value": "[parameters('NetBiosDomain')]"
                    },              
                    "Internaldomainname": {
                        "value": "[variables('InternaldomainName')]"
                    },          
                    "Externaldomainname": {
                        "value": "[variables('ExternaldomainName')]"
                    },   
                    "EnterpriseCAName": {
                        "value": "[parameters('EnterpriseCAName')]"
                    },              
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },                                                                                                            
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },              
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },                                                                                                            
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-FileServer-01",
            "dependsOn": [
                "Configure-EnterpriseCertificateAuthority"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/1nic-1disk-vm.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "NetworkInterfacesAPIVersion": {
                        "value": "[variables('NetworkInterfacesAPIVersion')]"
                    },
                    "VirtualMachinesAPIVersion": {
                        "value": "[variables('VirtualMachinesAPIVersion')]"
                    },
                    "SchedulesAPIVersion": {
                        "value": "[variables('SchedulesAPIVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('fs1name')]"
                    },
                    "computerIP": {
                        "value": "[variables('fs1IP')]"
                    },
                    "Publisher": {
                        "value": "MicrosoftWindowsServer"
                    },
                    "Offer": {
                        "value": "WindowsServer"
                    },
                    "OSSku": {
                        "value": "[parameters('FSOSSku')]"
                    },
                    "OSVersion": {
                        "value": "[parameters('FSOSVersion')]"
                    },
                    "LicenseType": {
                        "value": "[parameters('WindowsServerLicenseType')]"
                    },
                    "VMSize": {
                        "value": "[parameters('FS1VMSize')]"
                    },
                    "vnetName": {
                        "value": "[variables('vnet1Name')]"
                    },
                    "subnet1Name": {
                        "value": "[variables('vnet1subnet1Name')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "TimeZone": {
                        "value": "[parameters('TimeZone')]"
                    },
                    "AutoShutdownEnabled": {
                        "value": "[parameters('AutoShutdownEnabled')]"
                    },
                    "AutoShutdownTime": {
                        "value": "[parameters('AutoShutdownTime')]"
                    },
                    "AutoShutdownEmail": {
                        "value": "[parameters('AutoShutdownEmail')]"
                    }
                }
            }
        },
		{
			"condition": "[equals(parameters('FSOSSku'),'2022-Datacenter')]",
			"type": "Microsoft.Resources/deployments",
			"apiVersion": "[variables('DeploymentAPIVersion')]",
			"name": "DomainJoinFileServer-01-22",
			"dependsOn": [
				"Deploy-FileServer-01"
			],      
			"properties": {
				"mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/domainjoin.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
				"parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "DJExtensionsTypeHandlerVersion": {
                        "value": "[variables('DJExtensionsTypeHandlerVersion')]"
                    },                    
					"computerName": {
						"value": "[variables('fs1name')]"
					},
					"domainName": {
						"value": "[variables('InternaldomainName')]"
					},
					"OUPath": {
						"value": "[variables('SRV22OUPath')]"
					},
					"domainJoinOptions": {
						"value": 3
					},
					"adminUsername": {
						"value": "[parameters('adminUsername')]"
					},                                                                                                            
					"adminPassword": {
						"value": "[parameters('adminPassword')]"
					}
				}
			}
		}, 
		{
			"condition": "[equals(parameters('FSOSSku'),'2019-Datacenter')]",
			"type": "Microsoft.Resources/deployments",
			"apiVersion": "[variables('DeploymentAPIVersion')]",
			"name": "DomainJoinFileServer-01-19",
			"dependsOn": [
				"Deploy-FileServer-01"
			],      
			"properties": {
				"mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/domainjoin.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
				"parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "DJExtensionsTypeHandlerVersion": {
                        "value": "[variables('DJExtensionsTypeHandlerVersion')]"
                    },                    
					"computerName": {
						"value": "[variables('fs1name')]"
					},
					"domainName": {
						"value": "[variables('InternaldomainName')]"
					},
					"OUPath": {
						"value": "[variables('SRV19OUPath')]"
					},
					"domainJoinOptions": {
						"value": 3
					},
					"adminUsername": {
						"value": "[parameters('adminUsername')]"
					},                                                                                                            
					"adminPassword": {
						"value": "[parameters('adminPassword')]"
					}
				}
			}
		},   
		{
			"condition": "[equals(parameters('FSOSSku'),'2016-Datacenter')]",
			"type": "Microsoft.Resources/deployments",
			"apiVersion": "[variables('DeploymentAPIVersion')]",
			"name": "DomainJoinFileServer-01-16",
			"dependsOn": [
				"Deploy-FileServer-01"
			],      
			"properties": {
				"mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/domainjoin.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
				"parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "DJExtensionsTypeHandlerVersion": {
                        "value": "[variables('DJExtensionsTypeHandlerVersion')]"
                    },                    
					"computerName": {
						"value": "[variables('fs1name')]"
					},
					"domainName": {
						"value": "[variables('InternaldomainName')]"
					},
					"OUPath": {
						"value": "[variables('SRV16OUPath')]"
					},
					"domainJoinOptions": {
						"value": 3
					},
					"adminUsername": {
						"value": "[parameters('adminUsername')]"
					},                                                                                                            
					"adminPassword": {
						"value": "[parameters('adminPassword')]"
					}
				}
			}
		},
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-ExchangeServer-01",
            "dependsOn": [
                "DomainJoinFileServer-01-22",
                "DomainJoinFileServer-01-19",
                "DomainJoinFileServer-01-16"                                
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/1nic-3disk-vm.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "NetworkInterfacesAPIVersion": {
                        "value": "[variables('NetworkInterfacesAPIVersion')]"
                    },
                    "VirtualMachinesAPIVersion": {
                        "value": "[variables('VirtualMachinesAPIVersion')]"
                    },
                    "SchedulesAPIVersion": {
                        "value": "[variables('SchedulesAPIVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('ex1name')]"
                    },
                    "computerIP": {
                        "value": "[variables('ex1IP')]"
                    },
                    "Publisher": {
                        "value": "MicrosoftWindowsServer"
                    },
                    "Offer": {
                        "value": "WindowsServer"
                    },
                    "OSSku": {
                        "value": "[parameters('EXOSSku')]"
                    },
                    "OSVersion": {
                        "value": "[parameters('EXOSVersion')]"
                    },
                    "LicenseType": {
                        "value": "[parameters('WindowsServerLicenseType')]"
                    },
                    "DataDisk1Name": {
                        "value": "Exchange"
                    },            
                    "DataDisk2Name": {
                        "value": "Software"
                    },                     
                    "VMSize": {
                        "value": "[parameters('EX1VMSize')]"
                    },
                    "vnetName": {
                        "value": "[variables('vnet1Name')]"
                    },
                    "subnet1Name": {
                        "value": "[variables('vnet1subnet1Name')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "TimeZone": {
                        "value": "[parameters('TimeZone')]"
                    },
                    "AutoShutdownEnabled": {
                        "value": "[parameters('AutoShutdownEnabled')]"
                    },
                    "AutoShutdownTime": {
                        "value": "[parameters('AutoShutdownTime')]"
                    },
                    "AutoShutdownEmail": {
                        "value": "[parameters('AutoShutdownEmail')]"
                    }
                }
            }
        },
		{
			"condition": "[equals(parameters('EXOSSku'),'2022-Datacenter')]",            
			"type": "Microsoft.Resources/deployments",
			"apiVersion": "[variables('DeploymentAPIVersion')]",
			"name": "DomainJoinExchangeServer-01-22",
			"dependsOn": [
				"Deploy-ExchangeServer-01"
			],      
			"properties": {
				"mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/domainjoin.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
				"parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "DJExtensionsTypeHandlerVersion": {
                        "value": "[variables('DJExtensionsTypeHandlerVersion')]"
                    },                    
					"computerName": {
						"value": "[variables('ex1name')]"
					},
					"domainName": {
						"value": "[variables('InternaldomainName')]"
					},
					"OUPath": {
						"value": "[variables('SRV22OUPath')]"
					},
					"domainJoinOptions": {
						"value": 3
					},
					"adminUsername": {
						"value": "[parameters('adminUsername')]"
					},                                                                                                            
					"adminPassword": {
						"value": "[parameters('adminPassword')]"
					}
				}
			}
		},
		{
			"condition": "[equals(parameters('EXOSSku'),'2019-Datacenter')]",            
			"type": "Microsoft.Resources/deployments",
			"apiVersion": "[variables('DeploymentAPIVersion')]",
			"name": "DomainJoinExchangeServer-01-19",
			"dependsOn": [
				"Deploy-ExchangeServer-01"
			],      
			"properties": {
				"mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/domainjoin.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
				"parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "DJExtensionsTypeHandlerVersion": {
                        "value": "[variables('DJExtensionsTypeHandlerVersion')]"
                    },                    
					"computerName": {
						"value": "[variables('ex1name')]"
					},
					"domainName": {
						"value": "[variables('InternaldomainName')]"
					},
					"OUPath": {
						"value": "[variables('SRV19OUPath')]"
					},
					"domainJoinOptions": {
						"value": 3
					},
					"adminUsername": {
						"value": "[parameters('adminUsername')]"
					},                                                                                                            
					"adminPassword": {
						"value": "[parameters('adminPassword')]"
					}
				}
			}
		},
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Prepare-ExchangeServer-01-Prereqs",
            "dependsOn": [
                "DomainJoinExchangeServer-01-22",
                "DomainJoinExchangeServer-01-19"
            ],      
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/prepareexchange19.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },                     
                    "computerName": {
                        "value": "[variables('ex1name')]"
                    }, 
                    "ExchangeSASUrl": {
                        "value": "[parameters('Exchange2019ISOUrl')]"
                    },                                         
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },                                                                                                            
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                }
            }
        },  
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Restart-ExchangeServer-01_01",
            "dependsOn": [
                "Prepare-ExchangeServer-01-Prereqs"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/restartvm2.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('ex1name')]"
                    },
                    "Identifier": {
                        "value": "[concat(variables('Identifier'),'-1')]"
                    },                    
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }
                }
            }
        }, 
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Prepare-ActiveDirectory-for-Exchange",
            "dependsOn": [
                "Restart-ExchangeServer-01_01"    
            ],      
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/prepareadexchange19.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },                    
                    "computerName": {
                        "value": "[variables('ex1name')]"
                    },
                    "ExchangeOrgName": {
                        "value": "[parameters('ExchangeOrgName')]"
                    },
                    "ExchangeLicenseTerms": {
                        "value": "[variables('ExchangeLicenseTerms')]"
                    },                                                          
                    "NetBiosDomain": {
                        "value": "[parameters('NetBiosDomain')]"
                    },
                    "dc1name": {
                        "value": "[variables('dc1name')]"
                    },                                                                                 
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },                                                                                                            
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },                                                                                                                                                                                                                                                                                                                                       
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },                                                                                                            
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Grant-ExchangeTrustedSubSystem-LocalAdmin",
            "dependsOn": [
                "DomainJoinFileServer-01-22",        
                "DomainJoinFileServer-01-19",        
                "DomainJoinFileServer-01-16",                        
                "Prepare-ActiveDirectory-for-Exchange"
            ],      
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/grantets.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },                     
                    "computerName": {
                        "value": "[variables('fs1name')]"
                    },              
                    "ExchangeSecurityGroup": {
                        "value": "[variables('ExchangeSecurityGroup')]"
                    },                                                
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },                                                                                                            
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                }
            }
        },     
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Install-ExchangeServer-01",
            "dependsOn": [
                "DomainJoinExchangeServer-01-22",
                "DomainJoinExchangeServer-01-19",
                "Prepare-ActiveDirectory-for-Exchange",
                "Grant-ExchangeTrustedSubSystem-LocalAdmin"
            ],      
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/exchange19.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },                     
                    "computerName": {
                        "value": "[variables('ex1name')]"
                    },            
                    "InternaldomainName": {
                        "value": "[variables('InternaldomainName')]"
                    },                                  
                    "ExchangeLicenseTerms": {
                        "value": "[variables('ExchangeLicenseTerms')]"
                    }, 
                    "NetBiosDomain": {
                        "value": "[parameters('NetBiosDomain')]"
                    },
                    "SetupDC": {
                        "value": "[variables('dc1name')]"
                    },                                                                
                    "DBName": {
                        "value": "[variables('db1name')]"
                    },       
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },                                                                                                            
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },                                                                                                                                                                                                                                                                                                                                                      
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },                                                                                                            
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                }
            }
        },    
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Configure-ExchangeServer-01",
            "dependsOn": [
                "Install-ExchangeServer-01"
            ],      
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/configexchange19.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },                                         
                    "computerName": {
                        "value": "[variables('ex1name')]"
                    },
                    "InternaldomainName": {
                        "value": "[variables('InternaldomainName')]"
                    },              
                    "ExternaldomainName": {
                        "value": "[variables('ExternaldomainName')]"
                    },                
                    "NetBiosDomain": {
                        "value": "[parameters('NetBiosDomain')]"
                    },
                    "BaseDN": {
                        "value": "[variables('BaseDN')]"
                    },                            
                    "ConfigDC": {
                        "value": "[variables('dc1name')]"
                    },       
                    "CAServerIP": {
                        "value": "[variables('ecaIP')]"
                    },                                                                                                                                                                                       
                    "Site": {
                        "value": "Site1"
                    },                            
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },                                                                                                            
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },                                                                                                                                                                                                                                                                                                                                                               
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },                                                                                                            
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Configure-DatabaseAvailabilityGroup",
            "dependsOn": [
                "Configure-ExchangeServer-01"
            ],      
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/configdag.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },                                         
                    "computerName": {
                        "value": "[variables('ex1name')]"
                    },
                    "InternaldomainName": {
                        "value": "[variables('InternaldomainName')]"
                    },               
                    "NetBiosDomain": {
                        "value": "[parameters('NetBiosDomain')]"
                    },              
                    "ConfigDC": {
                        "value": "[variables('dc1name')]"
                    },       
                    "Site1FSW": {
                        "value": "[variables('fs1name')]"
                    },                                                                                                                                                           
                    "DAGName": {
                        "value": "[variables('dag19name')]"
                    },                                                                                                                                                           
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },                                                                                                            
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },                                                                                                                                                                                                                                                                                                                                                               
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },                                                                                                            
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                }
            }
        },  
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Add-MailboxDatabaseCopy-DB01",
            "dependsOn": [
                "Configure-DatabaseAvailabilityGroup"
            ],      
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/addmbdbcopy.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },                                         
                    "computerName": {
                        "value": "[variables('ex1name')]"
                    },
                    "InternaldomainName": {
                        "value": "[variables('InternaldomainName')]"
                    },               
                    "NetBiosDomain": {
                        "value": "[parameters('NetBiosDomain')]"
                    },              
                    "ConfigDC": {
                        "value": "[variables('dc1name')]"
                    },       
                    "DBName": {
                        "value": "[variables('DB1Name')]"
                    },                                                                                                                                                                                       
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },                                                                                                            
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },                                                                                                                                                                                                                                                                                                                                                               
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },                                                                                                            
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                }
            }
        }, 
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Restart-ExchangeServer-01_02",
            "dependsOn": [
                "Add-MailboxDatabaseCopy-DB01"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/restartvm2.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('ex1name')]"
                    },
                    "Identifier": {
                        "value": "[concat(variables('Identifier'),'-2')]"
                    },                    
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "condition": "[equals(parameters('WK1OSSku'),'Windows-11')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-Workstation-01-11",
            "dependsOn": [
                "Restart-DomainController-01_01"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/1nic-1disk-vm.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "NetworkInterfacesAPIVersion": {
                        "value": "[variables('NetworkInterfacesAPIVersion')]"
                    },
                    "VirtualMachinesAPIVersion": {
                        "value": "[variables('VirtualMachinesAPIVersion')]"
                    },
                    "SchedulesAPIVersion": {
                        "value": "[variables('SchedulesAPIVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('wk1name')]"
                    },
                    "computerIP": {
                        "value": "[variables('wk1IP')]"
                    },
                    "Publisher": {
                        "value": "MicrosoftWindowsDesktop"
                    },
                    "Offer": {
                        "value": "Windows-11"
                    },
                    "OSSku": {
                        "value": "win11-21h2-ent"
                    },
                    "OSVersion": {
                        "value": "[parameters('WK1OSVersion')]"
                    },
                    "LicenseType": {
                        "value": "[parameters('WindowsClientLicenseType')]"
                    },
                    "VMSize": {
                        "value": "[parameters('WK1VMSize')]"
                    },
                    "vnetName": {
                        "value": "[variables('vnet1Name')]"
                    },
                    "subnet1Name": {
                        "value": "[variables('vnet1subnet2Name')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "TimeZone": {
                        "value": "[parameters('TimeZone')]"
                    },
                    "AutoShutdownEnabled": {
                        "value": "[parameters('AutoShutdownEnabled')]"
                    },
                    "AutoShutdownTime": {
                        "value": "[parameters('AutoShutdownTime')]"
                    },
                    "AutoShutdownEmail": {
                        "value": "[parameters('AutoShutdownEmail')]"
                    }
                }
            }
        },
        {
            "condition": "[equals(parameters('WK1OSSku'),'Windows-10')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-Workstation-01-10",
            "dependsOn": [
                "Restart-DomainController-01_01"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/1nic-1disk-vm.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "NetworkInterfacesAPIVersion": {
                        "value": "[variables('NetworkInterfacesAPIVersion')]"
                    },
                    "VirtualMachinesAPIVersion": {
                        "value": "[variables('VirtualMachinesAPIVersion')]"
                    },
                    "SchedulesAPIVersion": {
                        "value": "[variables('SchedulesAPIVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('wk1name')]"
                    },
                    "computerIP": {
                        "value": "[variables('wk1IP')]"
                    },
                    "Publisher": {
                        "value": "MicrosoftWindowsDesktop"
                    },
                    "Offer": {
                        "value": "Windows-10"
                    },
                    "OSSku": {
                        "value": "win10-21h2-ent"
                    },
                    "OSVersion": {
                        "value": "[parameters('WK1OSVersion')]"
                    },
                    "LicenseType": {
                        "value": "[parameters('WindowsClientLicenseType')]"
                    },
                    "VMSize": {
                        "value": "[parameters('WK1VMSize')]"
                    },
                    "vnetName": {
                        "value": "[variables('vnet1Name')]"
                    },
                    "subnet1Name": {
                        "value": "[variables('vnet1subnet2Name')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "TimeZone": {
                        "value": "[parameters('TimeZone')]"
                    },
                    "AutoShutdownEnabled": {
                        "value": "[parameters('AutoShutdownEnabled')]"
                    },
                    "AutoShutdownTime": {
                        "value": "[parameters('AutoShutdownTime')]"
                    },
                    "AutoShutdownEmail": {
                        "value": "[parameters('AutoShutdownEmail')]"
                    }
                }
            }
        },
        {
            "condition": "[equals(parameters('WK1OSSku'),'Windows-7')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-Workstation-01-7",
            "dependsOn": [
                "Restart-DomainController-01_01"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/1nic-1disk-vm.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "NetworkInterfacesAPIVersion": {
                        "value": "[variables('NetworkInterfacesAPIVersion')]"
                    },
                    "VirtualMachinesAPIVersion": {
                        "value": "[variables('VirtualMachinesAPIVersion')]"
                    },
                    "SchedulesAPIVersion": {
                        "value": "[variables('SchedulesAPIVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('wk1name')]"
                    },
                    "computerIP": {
                        "value": "[variables('wk1IP')]"
                    },
                    "Publisher": {
                        "value": "MicrosoftWindowsDesktop"
                    },
                    "Offer": {
                        "value": "Windows-7"
                    },
                    "OSSku": {
                        "value": "win7-enterprise"
                    },
                    "OSVersion": {
                        "value": "[parameters('WK1OSVersion')]"
                    },
                    "LicenseType": {
                        "value": "[parameters('WindowsClientLicenseType')]"
                    },
                    "VMSize": {
                        "value": "[parameters('WK1VMSize')]"
                    },
                    "vnetName": {
                        "value": "[variables('vnet1Name')]"
                    },
                    "subnet1Name": {
                        "value": "[variables('vnet1subnet2Name')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "TimeZone": {
                        "value": "[parameters('TimeZone')]"
                    },
                    "AutoShutdownEnabled": {
                        "value": "[parameters('AutoShutdownEnabled')]"
                    },
                    "AutoShutdownTime": {
                        "value": "[parameters('AutoShutdownTime')]"
                    },
                    "AutoShutdownEmail": {
                        "value": "[parameters('AutoShutdownEmail')]"
                    }
                }
            }
        },
        {
            "condition": "[equals(parameters('WK1OSSku'),'Windows-11')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "DomainJoin-Workstation-01-11",
            "dependsOn": [
                "Create-ActiveDirectory-OUs",
                "Deploy-Workstation-01-11",
                "Deploy-Workstation-01-10",
                "Deploy-Workstation-01-7"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/domainjoin.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "DJExtensionsTypeHandlerVersion": {
                        "value": "[variables('DJExtensionsTypeHandlerVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('wk1name')]"
                    },
                    "domainName": {
                        "value": "[variables('InternalDomainName')]"
                    },
                    "OUPath": {
                        "value": "[variables('WIN11OUPath')]"
                    },
                    "domainJoinOptions": {
                        "value": 3
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    }
                }
            }
        },
        {
            "condition": "[equals(parameters('WK1OSSku'),'Windows-10')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "DomainJoin-Workstation-01-10",
            "dependsOn": [
                "Create-ActiveDirectory-OUs",
                "Deploy-Workstation-01-11",
                "Deploy-Workstation-01-10",
                "Deploy-Workstation-01-7"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/domainjoin.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "DJExtensionsTypeHandlerVersion": {
                        "value": "[variables('DJExtensionsTypeHandlerVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('wk1name')]"
                    },
                    "domainName": {
                        "value": "[variables('InternalDomainName')]"
                    },
                    "OUPath": {
                        "value": "[variables('WIN10OUPath')]"
                    },
                    "domainJoinOptions": {
                        "value": 3
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    }
                }
            }
        },
        {
            "condition": "[equals(parameters('WK1OSSku'),'Windows-7')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "DomainJoin-Workstation-01-7",
            "dependsOn": [
                "Create-ActiveDirectory-OUs",
                "Deploy-Workstation-01-11",
                "Deploy-Workstation-01-10",
                "Deploy-Workstation-01-7"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/domainjoin.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "DJExtensionsTypeHandlerVersion": {
                        "value": "[variables('DJExtensionsTypeHandlerVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('wk1name')]"
                    },
                    "domainName": {
                        "value": "[variables('InternalDomainName')]"
                    },
                    "OUPath": {
                        "value": "[variables('WIN7OUPath')]"
                    },
                    "domainJoinOptions": {
                        "value": 3
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    }
                }
            }
        },                                                     
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-NetworksecurityGroup-01",
            "dependsOn": [
                "Restart-ExchangeServer-01_02"    
            ],      
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/exchangenetworksecuritygroup.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "NetworkSecurityGroupAPIVersion": {
                        "value": "[variables('NetworkSecurityGroupAPIVersion')]"
                    },                    
                    "NetworkSecurityGroupname": {
                        "value": "[variables('NSG1Name')]"
                    },                                                                                                      
                    "OCSPPrivateIP": {
                        "value": "[variables('ocspIP')]"
                    },
                    "EX1PrivateIP": {
                        "value": "[variables('ex1IP')]"
                    }                    
                }
            }
        },                                   
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Associate-NSG-with-Subnet1",
            "dependsOn": [
                "Deploy-NetworksecurityGroup-01"
            ],            
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/associatesubnetnsg.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "VirtualNetworkAPIVersion": {
                        "value": "[variables('VirtualNetworkAPIVersion')]"
                    },                    
                    "vnetName": {
                        "value": "[variables('vnet1Name')]"
                    },
                    "subnetName": {
                        "value": "[variables('vnet1subnet1Name')]"
                    },                                                                                                            
                    "subnetPrefix": {
                        "value": "[variables('vnet1subnet1Prefix')]"
                    }, 
                    "NetworkSecurityGroupname": {
                        "value": "[variables('NSG1Name')]"
                    }                                                                                                                                                                                                                             
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Associate-NSG-with-Subnet2",
            "dependsOn": [
                "Associate-NSG-with-Subnet1"
            ],            
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/associatesubnetnsg.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "VirtualNetworkAPIVersion": {
                        "value": "[variables('VirtualNetworkAPIVersion')]"
                    },                    
                    "vnetName": {
                        "value": "[variables('vnet1Name')]"
                    },
                    "subnetName": {
                        "value": "[variables('vnet1subnet2Name')]"
                    },                                                                                                            
                    "subnetPrefix": {
                        "value": "[variables('vnet1subnet2Prefix')]"
                    }, 
                    "NetworkSecurityGroupname": {
                        "value": "[variables('NSG1Name')]"
                    }                                                                                                                                                                                                                             
                }
            }
        },        
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Add-PublicIP-to-OCSPServer",
            "dependsOn": [
                "Associate-NSG-with-Subnet1",
                "Associate-NSG-with-Subnet2"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/1nic-1disk-vm-pip.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "PublicIPAddressesAPIVersion": {
                        "value": "[variables('PublicIPAddressesAPIVersion')]"
                    },                    
                    "NetworkInterfacesAPIVersion": {
                        "value": "[variables('NetworkInterfacesAPIVersion')]"
                    },
                    "VirtualMachinesAPIVersion": {
                        "value": "[variables('VirtualMachinesAPIVersion')]"
                    },
                    "SchedulesAPIVersion": {
                        "value": "[variables('SchedulesAPIVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('ocspname')]"
                    },
                    "computerIP": {
                        "value": "[variables('ocspIP')]"
                    },
                    "Publisher": {
                        "value": "MicrosoftWindowsServer"
                    },
                    "Offer": {
                        "value": "WindowsServer"
                    },
                    "OSSku": {
                        "value": "[parameters('OCSPOSSku')]"
                    },
                    "OSVersion": {
                        "value": "[parameters('OCSPOSVersion')]"
                    },
                    "LicenseType": {
                        "value": "[parameters('WindowsServerLicenseType')]"
                    },
                    "VMSize": {
                        "value": "[parameters('OCSPVMSize')]"
                    },
                    "vnetName": {
                        "value": "[variables('vnet1Name')]"
                    },
                    "subnet1Name": {
                        "value": "[variables('vnet1subnet1Name')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "TimeZone": {
                        "value": "[parameters('TimeZone')]"
                    },
                    "AutoShutdownEnabled": {
                        "value": "[parameters('AutoShutdownEnabled')]"
                    },
                    "AutoShutdownTime": {
                        "value": "[parameters('AutoShutdownTime')]"
                    },
                    "AutoShutdownEmail": {
                        "value": "[parameters('AutoShutdownEmail')]"
                    }
                }
            }
        },                       
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Add-PublicIP-to-ExchangeServer-01",
            "dependsOn": [
                "Associate-NSG-with-Subnet1",
                "Associate-NSG-with-Subnet2"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/1nic-3disk-vm-pip.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "PublicIPAddressesAPIVersion": {
                        "value": "[variables('PublicIPAddressesAPIVersion')]"
                    },                    
                    "NetworkInterfacesAPIVersion": {
                        "value": "[variables('NetworkInterfacesAPIVersion')]"
                    },
                    "VirtualMachinesAPIVersion": {
                        "value": "[variables('VirtualMachinesAPIVersion')]"
                    },
                    "SchedulesAPIVersion": {
                        "value": "[variables('SchedulesAPIVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('ex1name')]"
                    },
                    "computerIP": {
                        "value": "[variables('ex1IP')]"
                    },
                    "Publisher": {
                        "value": "MicrosoftWindowsServer"
                    },
                    "Offer": {
                        "value": "WindowsServer"
                    },
                    "OSSku": {
                        "value": "[parameters('EXOSSku')]"
                    },
                    "OSVersion": {
                        "value": "[parameters('EXOSVersion')]"
                    },
                    "LicenseType": {
                        "value": "[parameters('WindowsServerLicenseType')]"
                    },
                    "DataDisk1Name": {
                        "value": "Exchange"
                    },            
                    "DataDisk2Name": {
                        "value": "Software"
                    },                    
                    "VMSize": {
                        "value": "[parameters('EX1VMSize')]"
                    },
                    "vnetName": {
                        "value": "[variables('vnet1Name')]"
                    },
                    "subnet1Name": {
                        "value": "[variables('vnet1subnet1Name')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "TimeZone": {
                        "value": "[parameters('TimeZone')]"
                    },
                    "AutoShutdownEnabled": {
                        "value": "[parameters('AutoShutdownEnabled')]"
                    },
                    "AutoShutdownTime": {
                        "value": "[parameters('AutoShutdownTime')]"
                    },
                    "AutoShutdownEmail": {
                        "value": "[parameters('AutoShutdownEmail')]"
                    }
                }
            }
        },                               
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Create-PublicDNSZone",
            "dependsOn": [
                "Add-PublicIP-to-OCSPServer",
                "Add-PublicIP-to-ExchangeServer-01"
            ],            
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/publicdnszone.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "PublicDNSZoneAPIVersion": {
                        "value": "[variables('PublicDNSZoneAPIVersion')]"
                    },                                                                                                                                                                                                                                                                                                      
                    "ZoneName": {
                        "value": "[variables('ExternaldomainName')]"
                    }                                                                                                                                                                                                                                                                                                      
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Create-PublicDNSZone-PKI-Records",
            "dependsOn": [
                "Create-PublicDNSZone"
            ],            
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/publicdnszonepki.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "PublicDNSZoneAPIVersion": {
                        "value": "[variables('PublicDNSZoneAPIVersion')]"
                    },                            
                    "ZoneName": {
                        "value": "[variables('ExternaldomainName')]"
                    },
                    "OCSPRecord": {
                        "value": "ocsp"
                    },
                    "OCSPPublicIP": {
                        "value": "[reference('Add-PublicIP-to-OCSPServer').outputs.PublicIP.value]"             
                    }                                                                                                                                                                                                                                                                                                       
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Create-PublicDNSZone-Exchange19-Records",
            "dependsOn": [
                "Create-PublicDNSZone-PKI-Records"
            ],            
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/publicdnszoneexchange19.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "PublicDNSZoneAPIVersion": {
                        "value": "[variables('PublicDNSZoneAPIVersion')]"
                    },                            
                    "ZoneName": {
                        "value": "[variables('ExternaldomainName')]"
                    },
                    "OCSPRecord": {
                        "value": "ocsp"
                    },
                    "OCSPPublicIP": {
                        "value": "[reference('Add-PublicIP-to-OCSPServer').outputs.PublicIP.value]"             
                    },
                    "OWARecord": {
                        "value": "owa2019"
                    },
                    "AutoDiscoverRecord": {
                        "value": "autodiscover"
                    },
                    "OutlookRecord": {
                        "value": "outlook2019"
                    },
                    "EASRecord": {
                        "value": "eas2019"
                    },
                    "SMTP1Record": {
                        "value": "smtp1"
                    },    
                    "EX1PublicIP": {
                        "value": "[reference('Add-PublicIP-to-ExchangeServer-01').outputs.PublicIP.value]"             
                    }                                                                                                                                                                                                                                                                                                                            
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Send-Deployment-Completion-Email",
            "dependsOn": [
                "Restart-ExchangeServer-01_02",
                "Create-PublicDNSZone-Exchange19-Records"
            ],            
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/sendemail.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },                    
                    "computerName": {
                        "value": "[variables('ecaname')]"
                    },
                    "ToEmail": {
                        "value": "[parameters('ToEmail')]"
                    },              
                    "FromEmail": {
                        "value": "[variables('FromEmail')]"
                    },
                    "EnterpriseCAServerName": {
                        "value": "[variables('ecaname')]"
                    },                                                                                                                                      
                    "EnterpriseCAName": {
                        "value": "[parameters('EnterpriseCAName')]"
                    },
                    "InternalDomainName": {
                        "value": "[variables('InternaldomainName')]"
                    },
                    "ExchangeServerName": {
                        "value": "[variables('ex1name')]"
                    },
                    "NameServer1": {
                        "value": "[reference('Create-PublicDNSZone').outputs.NameServer1.value]"             
                    },                    
                    "NameServer2": {
                        "value": "[reference('Create-PublicDNSZone').outputs.NameServer2.value]"             
                    },                                        
                    "NameServer3": {
                        "value": "[reference('Create-PublicDNSZone').outputs.NameServer3.value]"             
                    },                                        
                    "NameServer4": {
                        "value": "[reference('Create-PublicDNSZone').outputs.NameServer4.value]"             
                    },                                        
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },                                                                                                            
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },                                                                                                                                                                                                                                                                                                                                                               
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },                                                                                                            
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                }
            }
        }                       
    ]
}