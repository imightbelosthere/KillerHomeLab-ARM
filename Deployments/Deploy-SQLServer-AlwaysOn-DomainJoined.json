{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "TimeZone": {
            "type": "string",
            "defaultValue": "Eastern Standard Time",
            "allowedValues": [
                "Afghanistan Standard Time",
                "Alaskan Standard Time",
                "Aleutian Standard Time",
                "Altai Standard Time",
                "Arab Standard Time",
                "Arabian Standard Time",
                "Arabic Standard Time",
                "Argentina Standard Time",
                "Astrakhan Standard Time",
                "Atlantic Standard Time",
                "AUS Central Standard Time",
                "Aus Central W. Standard Time",
                "AUS Eastern Standard Time",
                "Azerbaijan Standard Time",
                "Azores Standard Time",
                "Bahia Standard Time",
                "Bangladesh Standard Time",
                "Belarus Standard Time",
                "Bougainville Standard Time",
                "Canada Central Standard Time",
                "Cape Verde Standard Time",
                "Caucasus Standard Time",
                "Cen. Australia Standard Time",
                "Central America Standard Time",
                "Central Asia Standard Time",
                "Central Brazilian Standard Time",
                "Central Europe Standard Time",
                "Central European Standard Time",
                "Central Pacific Standard Time",
                "Central Standard Time (Mexico)",
                "Central Standard Time",
                "Chatham Islands Standard Time",
                "China Standard Time",
                "Cuba Standard Time",
                "Dateline Standard Time",
                "E. Africa Standard Time",
                "E. Australia Standard Time",
                "E. Europe Standard Time",
                "E. South America Standard Time",
                "Easter Island Standard Time",
                "Eastern Standard Time (Mexico)",
                "Eastern Standard Time",
                "Egypt Standard Time",
                "Ekaterinburg Standard Time",
                "Fiji Standard Time",
                "FLE Standard Time",
                "Georgian Standard Time",
                "GMT Standard Time",
                "Greenland Standard Time",
                "Greenwich Standard Time",
                "GTB Standard Time",
                "Haiti Standard Time",
                "Hawaiian Standard Time",
                "India Standard Time",
                "Iran Standard Time",
                "Israel Standard Time",
                "Jordan Standard Time",
                "Kaliningrad Standard Time",
                "Korea Standard Time",
                "Libya Standard Time",
                "Line Islands Standard Time",
                "Lord Howe Standard Time",
                "Magadan Standard Time",
                "Magallanes Standard Time",
                "Marquesas Standard Time",
                "Mauritius Standard Time",
                "Middle East Standard Time",
                "Montevideo Standard Time",
                "Morocco Standard Time",
                "Mountain Standard Time (Mexico)",
                "Mountain Standard Time",
                "Myanmar Standard Time",
                "N. Central Asia Standard Time",
                "Namibia Standard Time",
                "Nepal Standard Time",
                "New Zealand Standard Time",
                "Newfoundland Standard Time",
                "Norfolk Standard Time",
                "North Asia East Standard Time",
                "North Asia Standard Time",
                "North Korea Standard Time",
                "Omsk Standard Time",
                "Pacific SA Standard Time",
                "Pacific Standard Time (Mexico)",
                "Pacific Standard Time",
                "Pakistan Standard Time",
                "Paraguay Standard Time",
                "Qyzylorda Standard Time",
                "Romance Standard Time",
                "Russia Time Zone 10",
                "Russia Time Zone 11",
                "Russia Time Zone 3",
                "Russian Standard Time",
                "SA Eastern Standard Time",
                "SA Pacific Standard Time",
                "SA Western Standard Time",
                "Saint Pierre Standard Time",
                "Sakhalin Standard Time",
                "Samoa Standard Time",
                "Sao Tome Standard Time",
                "Saratov Standard Time",
                "SE Asia Standard Time",
                "Singapore Standard Time",
                "South Africa Standard Time",
                "Sri Lanka Standard Time",
                "Sudan Standard Time",
                "Syria Standard Time",
                "Taipei Standard Time",
                "Tasmania Standard Time",
                "Tocantins Standard Time",
                "Tokyo Standard Time",
                "Tomsk Standard Time",
                "Tonga Standard Time",
                "Transbaikal Standard Time",
                "Turkey Standard Time",
                "Turks And Caicos Standard Time",
                "Ulaanbaatar Standard Time",
                "US Eastern Standard Time",
                "US Mountain Standard Time",
                "UTC",
                "UTC+12",
                "UTC+13",
                "UTC-02",
                "UTC-08",
                "UTC-09",
                "UTC-11",
                "Venezuela Standard Time",
                "Vladivostok Standard Time",
                "Volgograd Standard Time",
                "W. Australia Standard Time",
                "W. Central Africa Standard Time",
                "W. Europe Standard Time",
                "W. Mongolia Standard Time",
                "West Asia Standard Time",
                "West Bank Standard Time",
                "West Pacific Standard Time",
                "Yakutsk Standard Time"
            ],
            "metadata": {
                "description": "Time Zone"
            }
        },
        "AutoShutdownEnabled": {
            "type": "string",
            "defaultValue": "No",
            "allowedValues": [
                "Yes",
                "No"
            ],
            "metadata": {
                "description": "Enabled Auto Shutdown.  !!!If Enabled, AutoShutdownEmail MUST be added!!!!"
            }
        },
        "AutoShutdownTime": {
            "type": "string",
            "defaultValue": "2000",
            "metadata": {
                "description": "24-Hour Clock Time for Auto-Shutdown Example: 1900 = 7PM"
            }
        },
        "AutoShutdownEmail": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Auto-Shutdown notification Email Example:  user@domain.com"
            }
        },
        "adminUsername": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "The name of the Administrator of the new VM and Domain"
            }
        },
        "adminPassword": {
            "type": "securestring",
            "metadata": {
                "description": "The password for the Administrator account of the new VM and Domain"
            }
        },
        "ServiceAccount": {
            "type": "string",
            "defaultValue": "SQLSvc",        
            "metadata": {
                "description": "SQL Service Account Name"
            }
        },
        "ServiceAccountPassword": {
            "type": "securestring",
            "metadata": {
            "description": "SQL Service Account Password"
            }
        },        
        "SQLAdminAccount": {
            "type": "string",
            "defaultValue": "SQLAdmin",                
            "metadata": {
                "description": "SQL Install Account Name"
            }
        },
        "SQLAdminAccountPassword": {
            "type": "securestring",
            "metadata": {
            "description": "SQL Admin Account Password"
            }
        },               
        "AzureUserObjectID": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Deployment Account Object ID"
            }
        },
        "WindowsServerLicenseType": {
            "type": "string",
            "defaultValue": "None",
            "allowedValues": [
                "None",
                "Windows_Server"
            ],
            "metadata": {
                "description": "Windows Server OS License Type"
            }
        },
        "SQLLicenseType": {
            "type": "string",
            "defaultValue": "AHUB",
            "allowedValues": [
                "AHUB",
                "DR",
                "PAYG"
            ],      
            "metadata": {
                "description": "SQL License Type"
            }
        },         
        "NamingConvention": {
            "type": "string",
            "defaultValue": "khl",
            "maxLength": 4,
            "metadata": {
                "description": "VNet1 Name"
            }
        },
        "SubDNSDomain": {
            "type": "string",
            "defaultValue": "sub1.",
            "metadata": {
                "description": "Sub DNS Domain Name Example:  sub1. must include a DOT AT END"
            }
        },
        "SubDNSBaseDN": {
            "type": "string",
            "defaultValue": "DC=sub1,",
            "metadata": {
                "description": "Sub DNS Domain Name Example:  DC=sub2,DC=sub1, must include COMMA AT END"
            }
        },
        "NetBiosDomain": {
            "type": "string",
            "defaultValue": "sub1",
            "maxLength": 15,
            "metadata": {
                "description": "NetBios Domain Name should the same name as the SubDNSDomain parameter minus the COMMA AT END if the SubDNSDomain and SubDNSBaseDN parameters are used to specify a Sub DNS Naming Structure, but it should be unique if these parameters aren't used."
            }
        },
        "InternalDomain": {
            "type": "string",
            "defaultValue": "killerhomelab",
            "metadata": {
                "description": "NetBios Domain Name"
            }
        },
        "InternalTLD": {
            "type": "string",
            "defaultValue": "com",
            "allowedValues": [
                "com",
                "net",
                "org",
                "edu",
                "gov",
                "mil",
                "us",
                "tk",
                "ml",
                "local"
            ],
            "metadata": {
                "description": "Top-Level Domain Name"
            }
        },
        "vnet1ID": {
            "type": "string",
            "defaultValue": "172.16",
            "metadata": {
                "description": "VNet1 Prefix"
            }
        },
        "availabilitySetUpdateDomainCount": {
            "defaultValue": 5,
            "allowedValues": [
                1,
                2,
                3,
                4,
                5,
                6,
                7,
                8,
                9,
                10,
                11,
                12,
                13,
                14,
                15,
                16,
                17,
                18,
                19,
                20
            ],
            "type": "Int",
            "metadata": {
                "description": "The platform update domain count of avaiability set to be created."
            }
        },
        "availabilitySetFaultDomainCount": {
            "defaultValue": 2,
            "allowedValues": [
                1,
                2,
                3
            ],
            "type": "Int",
            "metadata": {
                "description": "The platform fault domain count of avaiability set to be created."
            }
        },
        "SQLVMSize": {
            "type": "string",
            "defaultValue": "Standard_d8ds_v5",
            "metadata": {
                "description": "SQL VMSize"
            }
        },   
        "SQLTOOLSOSSku": {
            "type": "string",
            "defaultValue": "2022-Datacenter",
            "allowedValues": [
                "2022-Datacenter",
                "2019-Datacenter",
                "2016-Datacenter",
                "2012-R2-Datacenter"
            ],
            "metadata": {
                "description": "SQL Tools VM OS Sku"
            }
        },
        "SQLTOOLSOSVersion": {
            "type": "string",
            "defaultValue": "latest",
            "metadata": {
                "description": "SQL Tools VM OS Version Number (Example:  2022-Datacenter=20348.707.220505, 2019-Datacenter=17763.3131.220505, 2016-Datacenter=14393.5125.220505, 2012-R2-Datacenter=9600.20371.220504)"
            }
        },
        "SQLTOOLSVMSize": {
            "type": "string",
            "defaultValue": "Standard_d2ds_v5",
            "metadata": {
                "description": "SQL Tools VMSize"
            }
        },                                      
        "_artifactsLocation": {
            "type": "string",
            "metadata": {
                "description": "The location of resources, such as templates and DSC modules, that the template depends on"
            },
            "defaultValue": "https://raw.githubusercontent.com/elliottfieldsjr/KillerHomeLab-ARM/comingsoon/"
        },
        "_artifactsLocationSasToken": {
            "type": "securestring",
            "metadata": {
                "description": "Auto-generated token to access _artifactsLocation. Leave it blank unless you need to provide your own value."
            },
            "defaultValue": ""
        }
    },
    "variables": {
        "DeploymentName": "[deployment().name]",
        "Environment": "[environment().name]",
        "StorageEndpoint": "[if(equals(variables('Environment'),concat('AzureUSGovernment')), 'core.usgovcloudapi.net', 'core.windows.net')]",
        "Identifier": "[substring(variables('DeploymentName'), 19, 14)]",
        "KeyVaultName": "[concat('SQLAO-', variables('Identifier'))]",
        "SecretName": "[concat(resourceGroup().Name,'-Password')]",
        "vnet1Name": "[concat(parameters('NamingConvention'),'-VNet1')]",
        "vnet1subnet1Name": "[concat(parameters('NamingConvention'),'-VNet1-Subnet1')]",
        "vnet1subnet1Prefix": "[concat(parameters('vnet1ID'),'.1.0/24')]", 
        "vnet1subnet2Name": "[concat(parameters('NamingConvention'),'-VNet1-Subnet2')]",               
        "dc1name": "[concat(parameters('NamingConvention'),'-dc-01')]",        
        "InternaldomainName": "[concat(parameters('SubDNSDomain'),parameters('InternalDomain'),'.',parameters('InternalTLD'))]",        
        "BaseDN": "[concat(parameters('SubDNSBaseDN'),'DC=',parameters('InternalDomain'),',DC=',parameters('InternalTLD'))]",
        "SRV22OUPath": "[concat('OU=Servers2022,OU=Servers,',variables('BaseDN'))]",
        "SRV19OUPath": "[concat('OU=Servers2019,OU=Servers,',variables('BaseDN'))]",
        "SRV16OUPath": "[concat('OU=Servers2016,OU=Servers,',variables('BaseDN'))]", 
        "AvailabilitySetName": "[concat(parameters('NamingConvention'),'-SQL-AVSet')]",
        "sqldbname": "[concat(parameters('NamingConvention'),'-db01')]",         
        "sqlname1": "[concat(parameters('NamingConvention'),'-sql-01')]",                      
        "sqlname2": "[concat(parameters('NamingConvention'),'-sql-02')]",
        "SQLClusterName": "[concat(parameters('NamingConvention'),'-clust')]",
        "SQLAccessPointName": "[concat(parameters('NamingConvention'),'-ap')]",        
        "SQLAvailabilityGroupName": "[concat(parameters('NamingConvention'),'-ag')]",                
        "SQLLoadBalancerName": "[concat(parameters('NamingConvention'),'-ap-lb')]",                        
        "SQLLoadBalancerSku": "Standard",
        "sqlapip": "[concat(parameters('vnet1ID'),'.1.',variables('sqlaplastoctet'))]", 
        "sqlaplastoctet": "140",  
        "sql1IP": "[concat(parameters('vnet1ID'),'.1.',variables('sql1lastoctet'))]", 
        "sql1lastoctet": "141",  
        "sql2IP": "[concat(parameters('vnet1ID'),'.1.',variables('sql2lastoctet'))]",                                      
        "sql2lastoctet": "142",   
        "sqltoolsname": "[concat(parameters('NamingConvention'),'-sqlt-01')]",
        "sqltoolsIP": "[concat(parameters('vnet1ID'),'.2.',variables('sqltoolslastoctet'))]",
        "sqltoolslastoctet": "140",        
        "AvailabilitySetsAPIVersion": "2022-03-01",        
        "DeploymentAPIVersion": "2021-04-01",
        "ExtensionsAPIVersion": "2022-03-01",
        "KeyVaultAPIVersion": "2021-11-01-preview",
        "KeyVaultSecretAPIVersion": "2021-11-01-preview",
        "LoadBalancerAPIVersion": "2022-05-01",                
        "NetworkInterfacesAPIVersion": "2021-08-01",
        "StorageAPIVersion": "2022-05-01",
        "VirtualMachinesAPIVersion": "2022-03-01",   
        "VirtualNetworkAPIVersion": "2020-11-01",             
        "SchedulesAPIVersion": "2018-09-15",
        "SQLVirtualMachinesAPIVersion": "2022-02-01",
        "ExtensionsTypeHandlerVersion": "2.83",
        "DJExtensionsTypeHandlerVersion": "1.3"
    },
    "resources": [
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Add-Storage-Service-Endpoint",            
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/enablesubnetserviceendpoint.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "VirtualNetworkAPIVersion": {
                        "value": "[variables('VirtualNetworkAPIVersion')]"
                    },
                    "ServiceEndpointName": {
                        "value": "Microsoft.Storage"
                    },                    
                    "vnetName": {
                        "value": "[variables('vnet1Name')]"
                    },
                    "subnetName": {
                        "value": "[variables('vnet1subnet1Name')]"
                    },
                    "subnetPrefix": {
                        "value": "[variables('vnet1subnet1Prefix')]"
                    }
                }
            }
        },        
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-Password-KeyVault-with-Secret",
            "Properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/keyvaultwithsecret.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "KeyVaultAPIVersion": {
                        "value": "[variables('KeyVaultAPIVersion')]"
                    },
                    "KeyVaultSecretAPIVersion": {
                        "value": "[variables('KeyVaultSecretAPIVersion')]"
                    },
                    "KeyVaultName": {
                        "value": "[variables('KeyVaultName')]"
                    },
                    "SecretName": {
                        "value": "[variables('SecretName')]"
                    },
                    "SecretValue": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "AzureUserObjectID": {
                        "value": "[parameters('AzureUserObjectID')]"
                    }
                }
            }
        },
        {
        "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Create-ActiveDirectory-SQL-Service-Accounts",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/sqlaccounts.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },                    
                    "computerName": {
                        "value": "[variables('dc1name')]"
                    },
                    "BaseDN": {
                        "value": "[variables('BaseDN')]"
                    },            
                    "DomainName": {
                        "value": "[variables('InternalDomainName')]"
                    },   
                    "NetBiosDomain": {
                        "value": "[parameters('NetBiosDomain')]"
                    },    
                    "ServiceAccount": {
                        "value": "[parameters('ServiceAccount')]"
                    },                  
                    "ServiceAccountPassword": {
                        "value": "[parameters('ServiceAccountPassword')]"
                    },                                           
                    "SQLAdminAccount": {
                        "value": "[parameters('SQLAdminAccount')]"
                    },                                
                    "SQLAdminAccountPassword": {
                        "value": "[parameters('SQLAdminAccountPassword')]"
                    },                       
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },                                                                                                            
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },   
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },                                                                                                            
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-SQL-Availability-Set",   
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/availabilityset.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "AvailabilitySetsAPIVersion": {
                        "value": "[variables('AvailabilitySetsAPIVersion')]"
                    },
                    "AvailabilitySetName": {
                        "value": "[variables('AvailabilitySetName')]"
                    },
                    "availabilitySetUpdateDomainCount": {
                        "value": "[parameters('availabilitySetUpdateDomainCount')]"
                    },
                    "availabilitySetFaultDomainCount": {
                        "value": "[parameters('availabilitySetFaultDomainCount')]"
                    } 
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-SQL2019-AzureVM-01",
            "dependsOn": [
                "Add-Storage-Service-Endpoint", 
                "Deploy-SQL-Availability-Set"
            ],           
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/1nic-3disk-vm-sql.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "NetworkInterfacesAPIVersion": {
                        "value": "[variables('NetworkInterfacesAPIVersion')]"
                    },
                    "VirtualMachinesAPIVersion": {
                        "value": "[variables('VirtualMachinesAPIVersion')]"
                    },
                    "SQLVirtualMachinesAPIVersion": {
                        "value": "[variables('SQLVirtualMachinesAPIVersion')]"
                    },                    
                    "SchedulesAPIVersion": {
                        "value": "[variables('SchedulesAPIVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('sqlname1')]"
                    },
                    "computerIP": {
                        "value":  "[variables('sql1IP')]"
                    },
                    "LicenseType": {
                        "value": "[parameters('WindowsServerLicenseType')]"
                    },
                    "SQLLicenseType": {
                        "value": "[parameters('SQLLicenseType')]"
                    },                    
                    "DataDisk0Name": {
                        "value": "SQLDatabases"
                    },            
                    "DataDisk1Name": {
                        "value": "SQLLogs"
                    },                     
                    "VMSize": {
                        "value": "[parameters('SQLVMSize')]"
                    },
                    "vnetName": {
                        "value": "[variables('vnet1Name')]"
                    },
                    "subnet1Name": {
                        "value": "[variables('vnet1subnet1Name')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "TimeZone": {
                        "value": "[parameters('TimeZone')]"
                    },
                    "AutoShutdownEnabled": {
                        "value": "[parameters('AutoShutdownEnabled')]"
                    },
                    "AutoShutdownTime": {
                        "value": "[parameters('AutoShutdownTime')]"
                    },
                    "AutoShutdownEmail": {
                        "value": "[parameters('AutoShutdownEmail')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "DomainJoin-SQL2019-AzureVM-01",
            "dependsOn": [
				"Deploy-SQL2019-AzureVM-01"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/domainjoin.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "DJExtensionsTypeHandlerVersion": {
                        "value": "[variables('DJExtensionsTypeHandlerVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('sqlname1')]"
                    },
                    "domainName": {
                        "value": "[variables('InternaldomainName')]"
                    },
                    "OUPath": {
                        "value": "[variables('SRV19OUPath')]"
                    },
                    "domainJoinOptions": {
                        "value": 3
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-SQL2019-AzureVM-02",
            "dependsOn": [
                "Add-Storage-Service-Endpoint", 
                "Deploy-SQL-Availability-Set"
            ],           
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/1nic-3disk-vm-sql.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "NetworkInterfacesAPIVersion": {
                        "value": "[variables('NetworkInterfacesAPIVersion')]"
                    },
                    "VirtualMachinesAPIVersion": {
                        "value": "[variables('VirtualMachinesAPIVersion')]"
                    },
                    "SQLVirtualMachinesAPIVersion": {
                        "value": "[variables('SQLVirtualMachinesAPIVersion')]"
                    },                    
                    "SchedulesAPIVersion": {
                        "value": "[variables('SchedulesAPIVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('sqlname2')]"
                    },
                    "computerIP": {
                        "value":  "[variables('sql2IP')]"
                    },
                    "LicenseType": {
                        "value": "[parameters('WindowsServerLicenseType')]"
                    },
                    "SQLLicenseType": {
                        "value": "[parameters('SQLLicenseType')]"
                    },                    
                    "DataDisk0Name": {
                        "value": "SQLDatabases"
                    },            
                    "DataDisk1Name": {
                        "value": "SQLLogs"
                    },                     
                    "VMSize": {
                        "value": "[parameters('SQLVMSize')]"
                    },
                    "vnetName": {
                        "value": "[variables('vnet1Name')]"
                    },
                    "subnet1Name": {
                        "value": "[variables('vnet1subnet1Name')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "TimeZone": {
                        "value": "[parameters('TimeZone')]"
                    },
                    "AutoShutdownEnabled": {
                        "value": "[parameters('AutoShutdownEnabled')]"
                    },
                    "AutoShutdownTime": {
                        "value": "[parameters('AutoShutdownTime')]"
                    },
                    "AutoShutdownEmail": {
                        "value": "[parameters('AutoShutdownEmail')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "DomainJoin-SQL2019-AzureVM-02",
            "dependsOn": [
				"Deploy-SQL2019-AzureVM-01"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/domainjoin.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "DJExtensionsTypeHandlerVersion": {
                        "value": "[variables('DJExtensionsTypeHandlerVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('sqlname2')]"
                    },
                    "domainName": {
                        "value": "[variables('InternaldomainName')]"
                    },
                    "OUPath": {
                        "value": "[variables('SRV19OUPath')]"
                    },
                    "domainJoinOptions": {
                        "value": 3
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Grant-SQL-AdminAccount-LocalAdmin-on-SQLVM1",
            "dependsOn": [
                "DomainJoin-SQL2019-AzureVM-01"
            ],      
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/grantlocaladmin.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },                     
                    "computerName": {
                        "value": "[variables('sqlname1')]"
                    },              
                    "Account": {
                        "value": "[parameters('SQLAdminAccount')]"
                    },            
                    "NetBiosDomain": {
                        "value": "[parameters('NetBiosDomain')]"
                    },    
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },                                                                                                            
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }              
                }
            }
        },  
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Grant-SQL-AdminAccount-LocalAdmin-on-SQLVM2",
            "dependsOn": [
                "DomainJoin-SQL2019-AzureVM-02"
            ],      
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/grantlocaladmin.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },                     
                    "computerName": {
                        "value": "[variables('sqlname2')]"
                    },              
                    "Account": {
                        "value": "[parameters('SQLAdminAccount')]"
                    },            
                    "NetBiosDomain": {
                        "value": "[parameters('NetBiosDomain')]"
                    },    
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },                                                                                                            
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }              
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Grant-SQL-Logins-for-Account-on-SQLVM1",
            "dependsOn": [
                "Grant-SQL-AdminAccount-LocalAdmin-on-SQLVM1"
            ],      
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/createsqllogin.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },                                         
                    "computerName": {
                        "value": "[variables('sqlname1')]"
                    },
                    "SQLAdminAccount": {
                        "value": "[parameters('SQLAdminAccount')]"
                    },                         
                    "NetBiosDomain": {
                        "value": "[parameters('NetBiosDomain')]"
                    },    
                    "DomainName": {
                        "value": "[variables('InternalDomainName')]"
                    },  
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },                                                                                                            
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },      
                    "ServiceAccount": {
                        "value": "[parameters('ServiceAccount')]"
                    },
                    "ServiceAccountPassword": {
                        "value": "[parameters('ServiceAccountPassword')]"
                    },                                                                                                                                                                                                                                                                                                                                             
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },                                                                                                            
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }              
                }
            }
        },                                                      
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Grant-SQL-Logins-for-Account-on-SQLVM2",
            "dependsOn": [
                "Grant-SQL-AdminAccount-LocalAdmin-on-SQLVM2"
            ],      
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/createsqllogin.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },                                         
                    "computerName": {
                        "value": "[variables('sqlname2')]"
                    },
                    "SQLAdminAccount": {
                        "value": "[parameters('SQLAdminAccount')]"
                    },                        
                    "NetBiosDomain": {
                        "value": "[parameters('NetBiosDomain')]"
                    },    
                    "DomainName": {
                        "value": "[variables('InternalDomainName')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },                                                                                                            
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "ServiceAccount": {
                        "value": "[parameters('ServiceAccount')]"
                    },
                    "ServiceAccountPassword": {
                        "value": "[parameters('ServiceAccountPassword')]"
                    },                                                                                                                                                                                                                                                                                                                                
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },                                                                                                            
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }              
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Install-WindowsFailoverClustering-on-SQLVM1",
            "dependsOn": [
                "Grant-SQL-Logins-for-Account-on-SQLVM1"
            ],      
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/installwfc.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },                                         
                    "computerName": {
                        "value": "[variables('sqlname1')]"
                    },
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },                                                                                                            
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }              
                }
            }
        },             
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Install-WindowsFailoverClustering-on-SQLVM2",
            "dependsOn": [
                "Grant-SQL-Logins-for-Account-on-SQLVM2"
            ],      
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/installwfc.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },                                         
                    "computerName": {
                        "value": "[variables('sqlname2')]"
                    },
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },                                                                                                            
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }              
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Restart-SQLVM01",
            "dependsOn": [
                "Install-WindowsFailoverClustering-on-SQLVM1"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/restartvm2.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('sqlname1')]"
                    },
                    "Identifier": {
                        "value": "[concat(variables('Identifier'),'-1')]"
                    },                    
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Restart-SQLVM02",
            "dependsOn": [
                "Install-WindowsFailoverClustering-on-SQLVM2"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/restartvm2.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('sqlname2')]"
                    },
                    "Identifier": {
                        "value": "[concat(variables('Identifier'),'-1')]"
                    },                    
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Create-FileShareWitness-StorageAccount",
            "dependsOn": [
                "Add-Storage-Service-Endpoint"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/storageprivate.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "StorageAPIVersion": {
                        "value": "[variables('StorageAPIVersion')]"
                    },
                    "StorageAccountNameHash": {
                        "value": "StorageAccount"
                    },
                    "vnetName": {
                        "value": "[variables('vnet1Name')]"
                    },
                    "subnet1Name": {
                        "value": "[variables('vnet1subnet1Name')]"
                    }                    
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Create-WindowsFailoverCluster-on-SQLVM1",
            "dependsOn": [
                "Add-Storage-Service-Endpoint",
                "Restart-SQLVM01",
                "Restart-SQLVM02",
                "Create-FileShareWitness-StorageAccount"
            ],      
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/createwfc.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },                                         
                    "computerName": {
                        "value": "[variables('sqlname1')]"
                    },
                    "NetBiosDomain": {
                        "value": "[parameters('NetBiosDomain')]"
                    },                        
                    "SQLClusterName": {
                        "value": "[variables('SQLClusterName')]"
                    },      
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },                                                                                                            
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },                                                                                                                                                                                                                                                                                                           
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },                                                                                                            
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }              
                }
            }
        },        
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Create-WindowsFailoverCluster-on-SQLVM2",
            "dependsOn": [
                "Restart-SQLVM01",
                "Restart-SQLVM02",
                "Create-FileShareWitness-StorageAccount",
                "Create-WindowsFailoverCluster-on-SQLVM1"
            ],      
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/createwfc.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },                                         
                    "computerName": {
                        "value": "[variables('sqlname2')]"
                    },
                    "NetBiosDomain": {
                        "value": "[parameters('NetBiosDomain')]"
                    },                        
                    "SQLClusterName": {
                        "value": "[variables('SQLClusterName')]"
                    },      
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },                                                                                                            
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },                                                                                                                                                                                                                                                                                                           
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },                                                                                                            
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }              
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Grant-WindowsFailoverCluster-Create-ComputerObject",
            "dependsOn": [
                "Create-WindowsFailoverCluster-on-SQLVM1",
                "Create-WindowsFailoverCluster-on-SQLVM2"
            ],      
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/grantcluster.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },                                         
                    "computerName": {
                        "value": "[variables('dc1name')]"
                    },
                    "NetBiosDomain": {
                        "value": "[parameters('NetBiosDomain')]"
                    },                        
                    "SQLClusterName": {
                        "value": "[variables('SQLClusterName')]"
                    },   
                    "ClusterOUPath": {
                        "value": "[variables('SRV19OUPath')]"
                    },                                      
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },                                                                                                            
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },                                                                                                                                                                                                                                                                                                           
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },                                                                                                            
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }              
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Enable-SQLAlwaysOn-on-SQLVM1",
            "dependsOn": [
                "Grant-WindowsFailoverCluster-Create-ComputerObject"
            ],      
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/enablesqlalwayson.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },                                         
                    "computerName": {
                        "value": "[variables('sqlname1')]"
                    },
                    "NetBiosDomain": {
                        "value": "[parameters('NetBiosDomain')]"
                    },                        
                    "SQLAdminAccount": {
                        "value": "[parameters('SQLAdminAccount')]"
                    },                                
                    "SQLAdminAccountPassword": {
                        "value": "[parameters('SQLAdminAccountPassword')]"
                    },                       
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },                                                                                                            
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }              
                }
            }
        },                        
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Enable-SQLAlwaysOn-on-SQLVM2",
            "dependsOn": [
                "Grant-WindowsFailoverCluster-Create-ComputerObject",
                "Enable-SQLAlwaysOn-on-SQLVM1"
            ],      
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/enablesqlalwayson.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },                                         
                    "computerName": {
                        "value": "[variables('sqlname2')]"
                    },
                    "NetBiosDomain": {
                        "value": "[parameters('NetBiosDomain')]"
                    },                        
                    "SQLAdminAccount": {
                        "value": "[parameters('SQLAdminAccount')]"
                    },                                
                    "SQLAdminAccountPassword": {
                        "value": "[parameters('SQLAdminAccountPassword')]"
                    },                       
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },                                                                                                            
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }              
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-SQL-Azure-Internal-LoadBalancer",  
            "dependsOn": [
                "Add-Storage-Service-Endpoint"
            ],                           
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/internalloadbalancersql.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "LoadBalancerAPIVersion": {
                        "value": "[variables('LoadBalancerAPIVersion')]"
                    },                    
                    "LoadBalancerName": {
                        "value": "[variables('SQLLoadBalancerName')]"
                    },
                    "SQLAPName": {
                        "value": "[variables('SQLAccessPointName')]"
                    },    
                    "SQLAPIP": {
                        "value": "[variables('sqlapIP')]"
                    },                        
                    "vnetName": {
                        "value": "[variables('vnet1Name')]"
                    },               
                    "subnetName": {
                        "value": "[variables('vnet1subnet1Name')]"
                    },                         
                    "Sku": {
                        "value": "[variables('SQLLoadBalancerSku')]"
                    }
                }
            }
        },        
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Configure-SQLAlwaysOn-on-SQLVM1",
            "dependsOn": [
                "Deploy-SQL-Azure-Internal-LoadBalancer",
                "Enable-SQLAlwaysOn-on-SQLVM1",
                "Enable-SQLAlwaysOn-on-SQLVM2"    
            ],      
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/configsqlalwayson.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },                                         
                    "computerName": {
                        "value": "[variables('sqlname1')]"
                    },                   
                    "SQLAGName": {
                        "value": "[variables('SQLAvailabilityGroupName')]"
                    }, 
                    "SQLAPName": {
                        "value": "[variables('SQLAccessPointName')]"
                    },                
                    "SQLAPIP": {
                        "value": "[variables('sqlapIP')]"
                    },               
                    "SQLNode1": {
                        "value": "[variables('sqlname1')]"
                    },                     
                    "SQLNode2": {
                        "value": "[variables('sqlname2')]"
                    },   
                    "SQLDBName": {
                        "value": "[variables('sqldbname')]"
                    },                        
                    "SQLServiceAccount": {
                        "value": "[parameters('ServiceAccount')]"
                    },                
                    "NetBiosDomain": {
                        "value": "[parameters('NetBiosDomain')]"
                    },          
                    "DomainName": {
                        "value": "[variables('InternalDomainName')]"
                    },                        
                    "StorageAccountName": {
                        "value": "[reference('Create-FileShareWitness-StorageAccount').outputs.StorageAccountName.value]"
                    },                                            
                    "StorageAccountKey": {
                        "value": "[reference('Create-FileShareWitness-StorageAccount').outputs.Key.value]"             
                    },                    
                    "StorageEndpoint": {
                        "value": "[variables('StorageEndpoint')]"
                    },                                                                                                                                      
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },                                                                                                            
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "SQLAdminAccount": {
                        "value": "[parameters('SQLAdminAccount')]"
                    },             
                    "SQLAdminAccountPassword": {
                        "value": "[parameters('SQLAdminAccountPassword')]"
                    },                                                                                                                                                                                                                                                                                                                                                   
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },                                                                                                            
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }              
                }
            }
        },        
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Associate-LoadBalancer-with-SQLVM1",
            "dependsOn": [
                "Deploy-SQL-Azure-Internal-LoadBalancer",
                "Configure-SQLAlwaysOn-on-SQLVM1"
            ],           
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/associateinternalloadbalancer.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "NetworkInterfacesAPIVersion": {
                        "value": "[variables('NetworkInterfacesAPIVersion')]"
                    },                    
                    "computerName": {
                        "value": "[variables('sqlname1')]"
                    },
                    "ComputerIP": {
                        "value": "[variables('sql1IP')]"
                    },                                          
                    "LoadBalancerName": {
                        "value": "[variables('SQLLoadBalancerName')]"
                    },                       
                    "enableAcceleratedNetworking": {
                        "value": true
                    },                           
                    "subnetName": {
                        "value": "[variables('vnet1subnet1Name')]"
                    },           
                    "vnetName": {
                        "value": "[variables('vnet1Name')]"
                    }
                }
            }
        },               
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Associate-LoadBalancer-with-SQLVM2",
            "dependsOn": [
                "Associate-LoadBalancer-with-SQLVM1"
            ],           
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/associateinternalloadbalancer.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "NetworkInterfacesAPIVersion": {
                        "value": "[variables('NetworkInterfacesAPIVersion')]"
                    },                    
                    "computerName": {
                        "value": "[variables('sqlname2')]"
                    },
                    "ComputerIP": {
                        "value": "[variables('sql2IP')]"
                    },                                          
                    "LoadBalancerName": {
                        "value": "[variables('SQLLoadBalancerName')]"
                    },
                    "enableAcceleratedNetworking": {
                        "value": true
                    },                                                                                       
                    "subnetName": {
                        "value": "[variables('vnet1subnet1Name')]"
                    },           
                    "vnetName": {
                        "value": "[variables('vnet1Name')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-SQL-ManagementStudio-Tools-VM",
            "dependsOn": [
                "Add-Storage-Service-Endpoint"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/1nic-1disk-vm.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "NetworkInterfacesAPIVersion": {
                        "value": "[variables('NetworkInterfacesAPIVersion')]"
                    },
                    "VirtualMachinesAPIVersion": {
                        "value": "[variables('VirtualMachinesAPIVersion')]"
                    },
                    "SchedulesAPIVersion": {
                        "value": "[variables('SchedulesAPIVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('sqltoolsname')]"
                    },
                    "computerIP": {
                        "value": "[variables('sqltoolsIP')]"
                    },
                    "Publisher": {
                        "value": "MicrosoftWindowsServer"
                    },
                    "Offer": {
                        "value": "WindowsServer"
                    },
                    "OSSku": {
                        "value": "[parameters('SQLTOOLSOSSku')]"
                    },
                    "OSVersion": {
                        "value": "[parameters('SQLTOOLSOSVersion')]"
                    },
                    "LicenseType": {
                        "value": "[parameters('WindowsServerLicenseType')]"
                    },
                    "VMSize": {
                        "value": "[parameters('SQLTOOLSVMSize')]"
                    },
                    "vnetName": {
                        "value": "[variables('vnet1Name')]"
                    },
                    "subnet1Name": {
                        "value": "[variables('vnet1subnet2Name')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "TimeZone": {
                        "value": "[parameters('TimeZone')]"
                    },
                    "AutoShutdownEnabled": {
                        "value": "[parameters('AutoShutdownEnabled')]"
                    },
                    "AutoShutdownTime": {
                        "value": "[parameters('AutoShutdownTime')]"
                    },
                    "AutoShutdownEmail": {
                        "value": "[parameters('AutoShutdownEmail')]"
                    }
                }
            }
        },     
		{
			"condition": "[equals(parameters('SQLTOOLSOSSku'),'2022-Datacenter')]",
			"type": "Microsoft.Resources/deployments",
			"apiVersion": "[variables('DeploymentAPIVersion')]",
			"name": "DomainJoinSQL-ManagementStudio-Tools-VM-22",
			"dependsOn": [
				"Deploy-SQL-ManagementStudio-Tools-VM"
			],      
			"properties": {
				"mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/domainjoin.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
				"parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "DJExtensionsTypeHandlerVersion": {
                        "value": "[variables('DJExtensionsTypeHandlerVersion')]"
                    },                    
					"computerName": {
						"value": "[variables('sqltoolsname')]"
					},
					"domainName": {
						"value": "[variables('InternaldomainName')]"
					},
					"OUPath": {
						"value": "[variables('SRV22OUPath')]"
					},
					"domainJoinOptions": {
						"value": 3
					},
					"adminUsername": {
						"value": "[parameters('adminUsername')]"
					},                                                                                                            
					"adminPassword": {
						"value": "[parameters('adminPassword')]"
					}
				}
			}
		}, 
		{
			"condition": "[equals(parameters('SQLTOOLSOSSku'),'2019-Datacenter')]",
			"type": "Microsoft.Resources/deployments",
			"apiVersion": "[variables('DeploymentAPIVersion')]",
			"name": "DomainJoinSQL-ManagementStudio-Tools-VM-19",
			"dependsOn": [
				"Deploy-SQL-ManagementStudio-Tools-VM"
			],      
			"properties": {
				"mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/domainjoin.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
				"parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "DJExtensionsTypeHandlerVersion": {
                        "value": "[variables('DJExtensionsTypeHandlerVersion')]"
                    },                    
					"computerName": {
						"value": "[variables('sqltoolsname')]"
					},
					"domainName": {
						"value": "[variables('InternaldomainName')]"
					},
					"OUPath": {
						"value": "[variables('SRV19OUPath')]"
					},
					"domainJoinOptions": {
						"value": 3
					},
					"adminUsername": {
						"value": "[parameters('adminUsername')]"
					},                                                                                                            
					"adminPassword": {
						"value": "[parameters('adminPassword')]"
					}
				}
			}
		},   
		{
			"condition": "[equals(parameters('SQLTOOLSOSSku'),'2016-Datacenter')]",
			"type": "Microsoft.Resources/deployments",
			"apiVersion": "[variables('DeploymentAPIVersion')]",
			"name": "DomainJoinSQL-ManagementStudio-Tools-VM-16",
			"dependsOn": [
				"Deploy-SQL-ManagementStudio-Tools-VM"
			],      
			"properties": {
				"mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/domainjoin.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
				"parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "DJExtensionsTypeHandlerVersion": {
                        "value": "[variables('DJExtensionsTypeHandlerVersion')]"
                    },                    
					"computerName": {
						"value": "[variables('sqltoolsname')]"
					},
					"domainName": {
						"value": "[variables('InternaldomainName')]"
					},
					"OUPath": {
						"value": "[variables('SRV16OUPath')]"
					},
					"domainJoinOptions": {
						"value": 3
					},
					"adminUsername": {
						"value": "[parameters('adminUsername')]"
					},                                                                                                            
					"adminPassword": {
						"value": "[parameters('adminPassword')]"
					}
				}
			}
		},             
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Install-SQL-Management-Studio",
            "dependsOn": [
               "DomainJoinSQL-ManagementStudio-Tools-VM-22",
               "DomainJoinSQL-ManagementStudio-Tools-VM-19",
               "DomainJoinSQL-ManagementStudio-Tools-VM-19"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/ssms.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('sqltoolsname')]"
                    },
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Grant-SQL-AdminAccount-LocalAdmin-on-SQLTools",
            "dependsOn": [
                "Install-SQL-Management-Studio"
            ],      
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/grantlocaladmin.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },                     
                    "computerName": {
                        "value": "[variables('sqltoolsname')]"
                    },              
                    "Account": {
                        "value": "[parameters('SQLAdminAccount')]"
                    },            
                    "NetBiosDomain": {
                        "value": "[parameters('NetBiosDomain')]"
                    },    
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },                                                                                                            
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }              
                }
            }
        }                               
    ]
}