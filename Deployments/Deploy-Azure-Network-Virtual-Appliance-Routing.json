{
    "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptiondeploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {        
        "HUBRG": {
            "type": "string",
            "defaultValue": "HUB-RG",
            "metadata": {
                "description": "HUB Resource Group"
            }
        },        
        "SPKRegion": {
            "type": "string",
            "defaultValue": "USGovTexas", 
            "metadata": {
                "description": "Choose Region for Spoke Resources (Example: USGovTexas)"
            }
        },
        "SPKRG": {
            "type": "string",
            "defaultValue": "SPK-RG",
            "metadata": {
                "description": "Spoke Resource Group"
            }
        },        
        "SITE1Region": {
            "type": "string",
            "defaultValue": "USGovArizona", 
            "metadata": {
                "description": "Choose Region for Site1 Resources (Example: USGovArizona)"
            }
        }, 
        "SITE1RG": {
            "type": "string",
            "defaultValue": "SITE1-RG",
            "metadata": {
                "description": "Site1 Resource Group"
            }
        },                               
        "SITE2Region": {
            "type": "string",
            "defaultValue": "USDoDEast", 
            "metadata": {
                "description": "Choose Region for Site2 Resources  (Example: USDoDEast)"
            }
        },
        "SITE2RG": {
            "type": "string",
            "defaultValue": "SITE2-RG",
            "metadata": {
                "description": "Site2 Resource Group"
            }
        },                                                      
        "TimeZone": {
            "type": "string",
            "defaultValue": "Eastern Standard Time",
            "allowedValues": [
                "Afghanistan Standard Time",
                "Alaskan Standard Time",
                "Aleutian Standard Time",
                "Altai Standard Time",
                "Arab Standard Time",
                "Arabian Standard Time",
                "Arabic Standard Time",
                "Argentina Standard Time",
                "Astrakhan Standard Time",
                "Atlantic Standard Time",
                "AUS Central Standard Time",
                "Aus Central W. Standard Time",
                "AUS Eastern Standard Time",
                "Azerbaijan Standard Time",
                "Azores Standard Time",
                "Bahia Standard Time",
                "Bangladesh Standard Time",
                "Belarus Standard Time",
                "Bougainville Standard Time",
                "Canada Central Standard Time",
                "Cape Verde Standard Time",
                "Caucasus Standard Time",
                "Cen. Australia Standard Time",
                "Central America Standard Time",
                "Central Asia Standard Time",
                "Central Brazilian Standard Time",
                "Central Europe Standard Time",
                "Central European Standard Time",
                "Central Pacific Standard Time",
                "Central Standard Time (Mexico)",
                "Central Standard Time",
                "Chatham Islands Standard Time",
                "China Standard Time",
                "Cuba Standard Time",
                "Dateline Standard Time",
                "E. Africa Standard Time",
                "E. Australia Standard Time",
                "E. Europe Standard Time",
                "E. South America Standard Time",
                "Easter Island Standard Time",
                "Eastern Standard Time (Mexico)",
                "Eastern Standard Time",
                "Egypt Standard Time",
                "Ekaterinburg Standard Time",
                "Fiji Standard Time",
                "FLE Standard Time",
                "Georgian Standard Time",
                "GMT Standard Time",
                "Greenland Standard Time",
                "Greenwich Standard Time",
                "GTB Standard Time",
                "Haiti Standard Time",
                "Hawaiian Standard Time",
                "India Standard Time",
                "Iran Standard Time",
                "Israel Standard Time",
                "Jordan Standard Time",
                "Kaliningrad Standard Time",
                "Korea Standard Time",
                "Libya Standard Time",
                "Line Islands Standard Time",
                "Lord Howe Standard Time",
                "Magadan Standard Time",
                "Magallanes Standard Time",
                "Marquesas Standard Time",
                "Mauritius Standard Time",
                "Middle East Standard Time",
                "Montevideo Standard Time",
                "Morocco Standard Time",
                "Mountain Standard Time (Mexico)",
                "Mountain Standard Time",
                "Myanmar Standard Time",
                "N. Central Asia Standard Time",
                "Namibia Standard Time",
                "Nepal Standard Time",
                "New Zealand Standard Time",
                "Newfoundland Standard Time",
                "Norfolk Standard Time",
                "North Asia East Standard Time",
                "North Asia Standard Time",
                "North Korea Standard Time",
                "Omsk Standard Time",
                "Pacific SA Standard Time",
                "Pacific Standard Time (Mexico)",
                "Pacific Standard Time",
                "Pakistan Standard Time",
                "Paraguay Standard Time",
                "Qyzylorda Standard Time",
                "Romance Standard Time",
                "Russia Time Zone 10",
                "Russia Time Zone 11",
                "Russia Time Zone 3",
                "Russian Standard Time",
                "SA Eastern Standard Time",
                "SA Pacific Standard Time",
                "SA Western Standard Time",
                "Saint Pierre Standard Time",
                "Sakhalin Standard Time",
                "Samoa Standard Time",
                "Sao Tome Standard Time",
                "Saratov Standard Time",
                "SE Asia Standard Time",
                "Singapore Standard Time",
                "South Africa Standard Time",
                "Sri Lanka Standard Time",
                "Sudan Standard Time",
                "Syria Standard Time",
                "Taipei Standard Time",
                "Tasmania Standard Time",
                "Tocantins Standard Time",
                "Tokyo Standard Time",
                "Tomsk Standard Time",
                "Tonga Standard Time",
                "Transbaikal Standard Time",
                "Turkey Standard Time",
                "Turks And Caicos Standard Time",
                "Ulaanbaatar Standard Time",
                "US Eastern Standard Time",
                "US Mountain Standard Time",
                "UTC",
                "UTC+12",
                "UTC+13",
                "UTC-02",
                "UTC-08",
                "UTC-09",
                "UTC-11",
                "Venezuela Standard Time",
                "Vladivostok Standard Time",
                "Volgograd Standard Time",
                "W. Australia Standard Time",
                "W. Central Africa Standard Time",
                "W. Europe Standard Time",
                "W. Mongolia Standard Time",
                "West Asia Standard Time",
                "West Bank Standard Time",
                "West Pacific Standard Time",
                "Yakutsk Standard Time"
            ],
            "metadata": {
                "description": "Time Zone"
            }
        },
        "SQLSASUrl": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Enter a valid URL that points to the SQL 2019, 2017 or 2016 .ISO"
            }
        },          
        "AutoShutdownEnabled": {
            "type": "string",
            "defaultValue": "No",
            "allowedValues": [
                "Yes",
                "No"
            ],
            "metadata": {
                "description": "Enabled Auto Shutdown.  !!!If Enabled, AutoShutdownEmail MUST be added!!!!"
            }
        },
        "AutoShutdownTime": {
            "type": "string",
            "defaultValue": "2000",
            "metadata": {
                "description": "24-Hour Clock Time for Auto-Shutdown Example: 1900 = 7PM"
            }
        },
        "AutoShutdownEmail": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Auto-Shutdown notification Email Example:  user@domain.com"
            }
        },
        "adminUsername": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "The name of the Administrator of the new VM and Domain"
            }
        },
        "adminPassword": {
            "type": "securestring",
            "metadata": {
                "description": "The password for the Administrator account of the new VM and Domain"
            }
        },
        "AzureUserObjectID": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Deployment Account Object ID"
            }
        },
        "WindowsServerLicenseType": {
            "type": "string",
            "defaultValue": "None",
            "allowedValues": [
                "None",
                "Windows_Server"
            ],
            "metadata": {
                "description": "Windows Server OS License Type"
            }
        },
        "HUBNamingConvention": {
            "type": "string",
            "defaultValue": "HUB",
            "minLength": 1,
            "maxLength": 5,
            "metadata": {
                "description": "Hub Environment Naming Convention"
            }
        }, 
        "SPKNamingConvention": {
            "type": "string",
            "defaultValue": "SPK",
            "minLength": 1,
            "maxLength": 5,
            "metadata": {
                "description": "Spoke Environment Naming Convention"
            }
        },     
        "SITE1NamingConvention": {
            "type": "string",
            "defaultValue": "SITE1",
            "minLength": 1,
            "maxLength": 5,
            "metadata": {
                "description": "Site1 Environment Naming Convention"
            }
        },         
        "SITE2NamingConvention": {
            "type": "string",
            "defaultValue": "SITE2",
            "minLength": 1,
            "maxLength": 5,
            "metadata": {
                "description": "Site2 Environment Naming Convention"
            }
        },             
        "HUBVNetID": {
            "type": "string",
            "defaultValue": "172.16",
            "metadata": {
                "description": "Hub VNet Prefix"
            }
        },   
        "SPKVNetID": {
            "type": "string",
            "defaultValue": "172.17",
            "metadata": {
                "description": "Spoke VNet Prefix"
            }
        },     
        "SITE1VNetID": {
            "type": "string",
            "defaultValue": "10.1",
            "metadata": {
                "description": "Site1 VNet Prefix"
            }
        },         
        "SITE2VNetID": {
            "type": "string",
            "defaultValue": "10.2",
            "metadata": {
                "description": "Site2 VNet Prefix"
            }
        },             
        "NVAVMOSSku": {
            "type": "string",
            "defaultValue": "2022-Datacenter",
            "allowedValues": [
            "2022-Datacenter",
            "2019-Datacenter",
            "2016-Datacenter",
            "2012-R2-Datacenter"
            ],
            "metadata": {
                "description": "Network Virtual Appliance OS Version"
            }
        },
        "NVAVMOSVersion": {
            "type": "string",
            "defaultValue": "latest",
            "metadata": {
                "description": "NVA OS Version Number (Example:  2022-Datacenter=20348.707.220505, 2019-Datacenter=17763.3131.220505, 2016-Datacenter=14393.5125.220505, 2012-R2-Datacenter=9600.20371.220504)"
            }
        },        
        "HUBVMOSSku": {
            "type": "string",
            "defaultValue": "2022-Datacenter",
            "allowedValues": [
            "2022-Datacenter",
            "2019-Datacenter",
            "2016-Datacenter"
            ],            
            "metadata": {
                "description": "HUB VM OS Version"
            }
        },        
        "HUBVMOSVersion": {
            "type": "string",
            "defaultValue": "latest",
            "metadata": {
                "description": "HUB VM OS Version Number (Example:  2022-Datacenter=20348.707.220505, 2019-Datacenter=17763.3131.220505, 2016-Datacenter=14393.5125.220505)"
            }
        },                
        "SQLVMOSSku": {
            "type": "string",
            "defaultValue": "2022-Datacenter",
            "allowedValues": [
            "2022-Datacenter",
            "2019-Datacenter",
            "2016-Datacenter"
            ],            
            "metadata": {
                "description": "SQL VM OS Version"
            }
        },
        "SQLVMOSVersion": {
            "type": "string",
            "defaultValue": "latest",
            "metadata": {
                "description": "SQL VM OS Version Number (Example:  2022-Datacenter=20348.707.220505, 2019-Datacenter=17763.3131.220505, 2016-Datacenter=14393.5125.220505)"
            }
        },                    
        "SITE1VMOSSku": {
            "type": "string",
            "defaultValue": "2022-Datacenter",
            "allowedValues": [
            "2022-Datacenter",
            "2019-Datacenter",
            "2016-Datacenter"
            ],            
            "metadata": {
                "description": "Site1 VM OS Version"
            }
        },                
        "SITE1VMOSVersion": {
            "type": "string",
            "defaultValue": "latest",
            "metadata": {
                "description": "Site1 VM OS Version Number (Example:  2022-Datacenter=20348.707.220505, 2019-Datacenter=17763.3131.220505, 2016-Datacenter=14393.5125.220505)"
            }
        },                        
        "SITE2VMOSSku": {
            "type": "string",
            "defaultValue": "2022-Datacenter",
            "allowedValues": [
            "2022-Datacenter",
            "2019-Datacenter",
            "2016-Datacenter"
            ],            
            "metadata": {
                "description": "Site2 VM OS Version"
            }
        },                    
        "SITE2VMOSVersion": {
            "type": "string",
            "defaultValue": "latest",
            "metadata": {
                "description": "Site2 VM OS Version Number (Example:  2022-Datacenter=20348.707.220505, 2019-Datacenter=17763.3131.220505, 2016-Datacenter=14393.5125.220505)"
            }
        },                            
        "NVAVMSize": {
            "type": "string",
            "defaultValue": "Standard_D2s_v3",
            "metadata": {
                "description": "Network Virtual Appliance VMSize"
            }
        },                  
        "HUBVMSize": {
            "type": "string",
            "defaultValue": "Standard_D2s_v3",
            "metadata": {
                "description": "HUB VMSize"
            }
        },        
        "SITE1VMSize": {
            "type": "string",
            "defaultValue": "Standard_D2s_v3",
            "metadata": {
                "description": "Site1 VMSize"
            }
        },            
        "SITE2VMSize": {
            "type": "string",
            "defaultValue": "Standard_D2s_v3",
            "metadata": {
                "description": "Site2 VMSize"
            }
        },                
        "SQLVMSize": {
            "type": "string",
            "defaultValue": "Standard_D8s_v3",
            "metadata": {
                "description": "SQL VMSize"
            }
        },
        "_artifactsLocation": {
            "type": "string",
            "metadata": {
                "description": "The location of resources, such as templates and DSC modules, that the template depends on"
            },
            "defaultValue": "https://raw.githubusercontent.com/elliottfieldsjr/KillerHomeLab-ARM/comingsoon/"
        },
        "_artifactsLocationSasToken": {
            "type": "securestring",
            "metadata": {
                "description": "Auto-generated token to access _artifactsLocation. Leave it blank unless you need to provide your own value."
            },
            "defaultValue": ""
        }
    },
    "variables": {
        "DeploymentName": "[deployment().name]",
        "Identifier": "[substring(variables('DeploymentName'), 19, 14)]",
        "KeyVaultName": "[concat('NVA-', variables('Identifier'))]",
        "SecretName": "[concat(variables('KeyVaultName'),'-Password')]",
        "HUBVNetName": "[concat(parameters('HUBNamingConvention'),'-VNet')]",
        "HUBVNetPrefix": "[concat(parameters('HUBVNetID'),'.0.0/16')]",    
        "HUBVNetSubnet1Name": "[concat(parameters('HUBNamingConvention'),'-VNet-OutsideSubnet')]", 
        "HUBVNetSubnet1Prefix": "[concat(parameters('HUBVNetID'),'.1.0/24')]",           
        "HUBVNetSubnet2Name": "[concat(parameters('HUBNamingConvention'),'-VNet-InsideSubnet')]",  
        "HUBVNetSubnet2Prefix": "[concat(parameters('HUBVNetID'),'.2.0/24')]",    
        "HUBVNetGatewaySubnetPrefix": "[concat(parameters('HUBVNetID'),'.0.0/24')]",
        "HUBVNetBastionSubnetPrefix": "[concat(parameters('HUBVNetID'),'.253.0/24')]",
        "HUBVNetFirewallSubnetPrefix": "[concat(parameters('HUBVNetID'),'.254.0/24')]",
        "SPKVNetName": "[concat(parameters('SPKNamingConvention'),'-VNet')]",
        "SPKVNetPrefix": "[concat(parameters('SPKVNetID'),'.0.0/16')]",    
        "SPKVNetSubnet1Name": "[concat(parameters('SPKNamingConvention'),'-VNet-Subnet1')]", 
        "SPKVNetSubnet1Prefix": "[concat(parameters('SPKVNetID'),'.1.0/24')]",           
        "SPKVNetSubnet2Name": "[concat(parameters('SPKNamingConvention'),'-VNet-Subnet2')]",  
        "SPKVNetSubnet2Prefix": "[concat(parameters('SPKVNetID'),'.2.0/24')]",    
        "SPKVNetGatewaysubnetPrefix": "[concat(parameters('SPKVNetID'),'.0.0/24')]",
        "SPKVNetBastionsubnetPrefix": "[concat(parameters('SPKVNetID'),'.253.0/24')]",
        "SPKVNetFirewallsubnetPrefix": "[concat(parameters('SPKVNetID'),'.254.0/24')]",
        "SITE1VNetName": "[concat(parameters('SITE1NamingConvention'),'-VNet')]",
        "SITE1VNetPrefix": "[concat(parameters('SITE1VNetID'),'.0.0/16')]",    
        "SITE1VNetSubnet1Name": "[concat(parameters('SITE1NamingConvention'),'-VNet-Subnet1')]", 
        "SITE1VNetSubnet1Prefix": "[concat(parameters('SITE1VNetID'),'.1.0/24')]",           
        "SITE1VNetSubnet2Name": "[concat(parameters('SITE1NamingConvention'),'-VNet-Subnet2')]",  
        "SITE1VNetSubnet2Prefix": "[concat(parameters('SITE1VNetID'),'.2.0/24')]",    
        "SITE1VNetGatewaysubnetPrefix": "[concat(parameters('SITE1VNetID'),'.0.0/24')]",
        "SITE1VNetBastionsubnetPrefix": "[concat(parameters('SITE1VNetID'),'.253.0/24')]",
        "SITE1VNetFirewallsubnetPrefix": "[concat(parameters('SITE1VNetID'),'.254.0/24')]",
        "SITE2VNetName": "[concat(parameters('SITE2NamingConvention'),'-VNet')]",
        "SITE2VNetPrefix": "[concat(parameters('SITE2VNetID'),'.0.0/16')]",    
        "SITE2VNetSubnet1Name": "[concat(parameters('SITE2NamingConvention'),'-VNet-Subnet1')]", 
        "SITE2VNetSubnet1Prefix": "[concat(parameters('SITE2VNetID'),'.1.0/24')]",           
        "SITE2VNetSubnet2Name": "[concat(parameters('SITE2NamingConvention'),'-VNet-Subnet2')]",  
        "SITE2VNetSubnet2Prefix": "[concat(parameters('SITE2VNetID'),'.2.0/24')]",    
        "SITE2VNetGatewaysubnetPrefix": "[concat(parameters('SITE2VNetID'),'.0.0/24')]",    
        "SITE2VNetBastionsubnetPrefix": "[concat(parameters('SITE2VNetID'),'.253.0/24')]",    
        "SITE2VNetFirewallsubnetPrefix": "[concat(parameters('SITE2VNetID'),'.254.0/24')]",    
        "HUBRouteTableName": "[concat(parameters('HUBNamingConvention'),'-RT')]",                                                                
        "SPKRouteTableName": "[concat(parameters('SPKNamingConvention'),'-RT')]",                                                                
        "SITE1RouteTableName": "[concat(parameters('SITE1NamingConvention'),'-RT')]",                                                                
        "SITE2RouteTableName": "[concat(parameters('SITE2NamingConvention'),'-RT')]",                                                                            
        "NVAVMName": "[concat(parameters('HUBNamingConvention'),'-nva-01')]", 
        "NVA-Outside-IP": "[concat(parameters('HUBVNetID'),'.1.',variables('NVAOutLastOctet'))]",
        "NVA-Inside-IP": "[concat(parameters('HUBVNetID'),'.2.',variables('NVAInLastOctet'))]",            
        "NVAOutLastOctet": "254",        
        "NVAInLastOctet": "254",
        "HUBVMName": "[concat(parameters('HUBNamingConvention'),'-VM-01')]", 
        "HUBVMIP": "[concat(parameters('HUBVNetID'),'.2.',variables('HUBVMLastOctet'))]",
        "HUBVMLastOctet": "101",        
        "SQLVMName": "[concat(parameters('SPKNamingConvention'),'-sql-01')]", 
        "SQLVMIP": "[concat(parameters('SPKVNetID'),'.1.',variables('SQLVMLastOctet'))]",
        "SQLVMLastOctet": "101",        
        "SITE1VMName": "[concat(parameters('SITE1NamingConvention'),'-VM-01')]", 
        "SITE1VMIP": "[concat(parameters('SITE1VNetID'),'.1.',variables('SITE1VMLastOctet'))]",
        "SITE1VMLastOctet": "101",        
        "SITE2VMName": "[concat(parameters('SITE2NamingConvention'),'-VM-01')]", 
        "SITE2VMIP": "[concat(parameters('SITE2VNetID'),'.1.',variables('SITE2VMLastOctet'))]",
        "SITE2VMLastOctet": "101",            
        "SITE1NextHop": "[concat(parameters('SITE1VNetID'),'.1.1')]",            
        "SITE2NextHop": "[concat(parameters('SITE2VNetID'),'.1.1')]",                
        "SpokeNextHop": "[concat(parameters('SPKVNetID'),'.1.1')]",                    
        "OutsideSubnetPrefix": "[concat(parameters('HUBVNetID'),'.1')]",                        
        "InsideSubnetPrefix": "[concat(parameters('HUBVNetID'),'.2')]",
        "BastionHostAPIVersion": "2021-08-01",
        "DeploymentAPIVersion": "2021-04-01",
        "ExtensionsAPIVersion": "2022-03-01",
        "KeyVaultAPIVersion": "2021-11-01-preview",
        "KeyVaultSecretAPIVersion": "2021-11-01-preview",
        "NetworkInterfacesAPIVersion": "2021-08-01",
        "PrivateDNSZoneAPIVersion": "2020-06-01",        
        "PublicIPAddressesAPIVersion": "2021-08-01",
        "ResourceGroupAPIVersion": "2021-04-01",  
        "RouteTableAPIVersion": "2022-05-01",
        "SchedulesAPIVersion": "2018-09-15",
        "VirtualMachinesAPIVersion": "2022-03-01",
        "VirtualNetworkAPIVersion": "2020-11-01",
        "VirtualNetworkPeeringAPIVersion": "2022-01-01",        
        "ExtensionsTypeHandlerVersion": "2.83"
    },
    "resources": [
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Create-Hub-ResourceGroup",
            "location": "[deployment().location]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/resourcegroup.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ResourceGroupAPIVersion": {
                        "value": "[variables('ResourceGroupAPIVersion')]"
                    },
                    "ResourceGroupName": {
                        "value": "[parameters('HUBRG')]"
                    }    
                }
            }
        },        
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Create-Spoke-ResourceGroup",
            "location": "[parameters('SPKRegion')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/resourcegroup.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ResourceGroupAPIVersion": {
                        "value": "[variables('ResourceGroupAPIVersion')]"
                    },
                    "ResourceGroupName": {
                        "value": "[parameters('SPKRG')]"
                    }            
                }
            }
        },                
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Create-Site1-ResourceGroup",
            "location": "[parameters('SITE1Region')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/resourcegroup.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ResourceGroupAPIVersion": {
                        "value": "[variables('ResourceGroupAPIVersion')]"
                    },
                    "ResourceGroupName": {
                        "value": "[parameters('SITE1RG')]"
                    }          
                }
            }
        },                        
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Create-Site2-ResourceGroup",
            "location": "[parameters('SITE2Region')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/resourcegroup.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ResourceGroupAPIVersion": {
                        "value": "[variables('ResourceGroupAPIVersion')]"
                    },
                    "ResourceGroupName": {
                        "value": "[parameters('SITE2RG')]"
                    }
                }
            }
        }, 
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-Password-KeyVault-with-Secret",
            "resourceGroup":  "[parameters('HUBRG')]",
            "dependsOn": [
                "Create-Hub-ResourceGroup"
            ],             
            "Properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/keyvaultwithsecret.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "KeyVaultAPIVersion": {
                        "value": "[variables('KeyVaultAPIVersion')]"
                    },
                    "KeyVaultSecretAPIVersion": {
                        "value": "[variables('KeyVaultSecretAPIVersion')]"
                    },
                    "KeyVaultName": {
                        "value": "[variables('KeyVaultName')]"
                    },
                    "SecretName": {
                        "value": "[variables('SecretName')]"
                    },
                    "SecretValue": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "AzureUserObjectID": {
                        "value": "[parameters('AzureUserObjectID')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-Hub-VirtualNetwork",
            "resourceGroup":  "[parameters('HUBRG')]",
            "dependsOn": [
                "Create-Hub-ResourceGroup"
            ],             
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/vnet.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "VirtualNetworkAPIVersion": {
                        "value": "[variables('VirtualNetworkAPIVersion')]"
                    },
                    "vnetName": {
                        "value": "[variables('HUBVNetName')]"
                    },
                    "vnetprefix": {
                        "value": "[variables('HUBVNetPrefix')]"
                    },
                    "subnet1Name": {
                        "value": "[variables('HUBVNetsubnet1Name')]"
                    },
                    "subnet1Prefix": {
                        "value": "[variables('HUBVNetsubnet1Prefix')]"
                    },
                    "subnet2Name": {
                        "value": "[variables('HUBVNetsubnet2Name')]"
                    },
                    "subnet2Prefix": {
                        "value": "[variables('HUBVNetsubnet2Prefix')]"
                    },
                    "GatewaysubnetPrefix": {
                        "value": "[variables('HUBVNetGatewaysubnetPrefix')]"
                    },
                    "BastionsubnetPrefix": {
                        "value": "[variables('HUBVNetBastionsubnetPrefix')]"
                    },
                    "FirewallsubnetPrefix": {
                        "value": "[variables('HUBVNetFirewallsubnetPrefix')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-BastionHost-01",
            "resourceGroup":  "[parameters('HUBRG')]",            
            "dependsOn": [
                "Deploy-Hub-VirtualNetwork"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/bastionhost.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "BastionHostAPIVersion": {
                        "value": "[variables('BastionHostAPIVersion')]"
                    },
                    "PublicIPAddressesAPIVersion": {
                        "value": "[variables('PublicIPAddressesAPIVersion')]"
                    },
                    "publicIPAddressName": {
                        "value": "[concat(variables('HUBVNetName'),'-Bastion-pip')]"
                    },
                    "AllocationMethod": {
                        "value": "Static"
                    },
                    "vnetName": {
                        "value": "[variables('HUBVNetName')]"
                    },
                    "subnetName": {
                        "value": "AzureBastionSubnet"
                    }
                }
            }
        },                                                    
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-Spoke-VirtualNetwork",
            "resourceGroup":  "[parameters('SPKRG')]",
            "dependsOn": [
                "Create-Spoke-ResourceGroup"
            ],             
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/vnet.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "VirtualNetworkAPIVersion": {
                        "value": "[variables('VirtualNetworkAPIVersion')]"
                    },
                    "vnetName": {
                        "value": "[variables('SPKVNetName')]"
                    },
                    "vnetprefix": {
                        "value": "[variables('SPKVNetPrefix')]"
                    },
                    "subnet1Name": {
                        "value": "[variables('SPKVNetsubnet1Name')]"
                    },
                    "subnet1Prefix": {
                        "value": "[variables('SPKVNetsubnet1Prefix')]"
                    },
                    "subnet2Name": {
                        "value": "[variables('SPKVNetsubnet2Name')]"
                    },
                    "subnet2Prefix": {
                        "value": "[variables('SPKVNetsubnet2Prefix')]"
                    },
                    "GatewaysubnetPrefix": {
                        "value": "[variables('SPKVNetGatewaysubnetPrefix')]"
                    },
                    "BastionsubnetPrefix": {
                        "value": "[variables('SPKVNetBastionsubnetPrefix')]"
                    },
                    "FirewallsubnetPrefix": {
                        "value": "[variables('SPKVNetFirewallsubnetPrefix')]"
                    }
                }
            }
        },                                       
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-Site1-VirtualNetwork",
            "resourceGroup":  "[parameters('SITE1RG')]",
            "dependsOn": [
                "Create-Site1-ResourceGroup"
            ],             
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/vnet.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "VirtualNetworkAPIVersion": {
                        "value": "[variables('VirtualNetworkAPIVersion')]"
                    },
                    "vnetName": {
                        "value": "[variables('SITE1VNetName')]"
                    },
                    "vnetprefix": {
                        "value": "[variables('SITE1VNetPrefix')]"
                    },
                    "subnet1Name": {
                        "value": "[variables('SITE1VNetsubnet1Name')]"
                    },
                    "subnet1Prefix": {
                        "value": "[variables('SITE1VNetsubnet1Prefix')]"
                    },
                    "subnet2Name": {
                        "value": "[variables('SITE1VNetsubnet2Name')]"
                    },
                    "subnet2Prefix": {
                        "value": "[variables('SITE1VNetsubnet2Prefix')]"
                    },
                    "GatewaysubnetPrefix": {
                        "value": "[variables('SITE1VNetGatewaysubnetPrefix')]"
                    },
                    "BastionsubnetPrefix": {
                        "value": "[variables('SITE1VNetBastionsubnetPrefix')]"
                    },
                    "FirewallsubnetPrefix": {
                        "value": "[variables('SITE1VNetFirewallsubnetPrefix')]"
                    }
                }
            }
        },                                           
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-Site2-VirtualNetwork",
            "resourceGroup":  "[parameters('SITE2RG')]",
            "dependsOn": [
                "Create-Site2-ResourceGroup"
            ],             
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/vnet.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "VirtualNetworkAPIVersion": {
                        "value": "[variables('VirtualNetworkAPIVersion')]"
                    },
                    "vnetName": {
                        "value": "[variables('SITE2VNetName')]"
                    },
                    "vnetprefix": {
                        "value": "[variables('SITE2VNetPrefix')]"
                    },
                    "subnet1Name": {
                        "value": "[variables('SITE2VNetsubnet1Name')]"
                    },
                    "subnet1Prefix": {
                        "value": "[variables('SITE2VNetsubnet1Prefix')]"
                    },
                    "subnet2Name": {
                        "value": "[variables('SITE2VNetsubnet2Name')]"
                    },
                    "subnet2Prefix": {
                        "value": "[variables('SITE2VNetsubnet2Prefix')]"
                    },
                    "GatewaysubnetPrefix": {
                        "value": "[variables('SITE2VNetGatewaysubnetPrefix')]"
                    },
                    "BastionsubnetPrefix": {
                        "value": "[variables('SITE2VNetBastionsubnetPrefix')]"
                    },
                    "FirewallsubnetPrefix": {
                        "value": "[variables('SITE2VNetFirewallsubnetPrefix')]"
                    }
                }
            }
        },                                           
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploying-Peering-On-Hub-for-Spoke",
            "resourceGroup":  "[parameters('HUBRG')]",                      
            "dependsOn": [
                "Deploy-Hub-VirtualNetwork",
                "Deploy-Spoke-VirtualNetwork"
            ],            
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/peeringrg.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "VirtualNetworkPeeringAPIVersion": {
                        "value": "[variables('VirtualNetworkPeeringAPIVersion')]"
                    },                    
                    "SourceVNetName": {
                        "value": "[variables('HUBVNetName')]"
                    },
                    "TargetVNetName": {
                        "value": "[variables('SPKVNetName')]"
                    },              
                    "TargetVNetRG": {
                        "value": "[parameters('SPKRG')]"
                    },                            
                    "allowVirtualNetworkAccess": {
                        "value": "true"
                    },                                                                                                                                                                                                                                                                                                           
                    "allowForwardedTraffic": {
                        "value": "true"
                    },                                                                                                                                                                                                                                                                                                           
                    "allowGatewayTransit": {
                        "value": "false"
                    },
                    "useRemoteGateways": {
                        "value": "false"
                    }
                }
            }
        },            
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploying-Peering-On-Spoke-for-Hub",
            "resourceGroup":  "[parameters('SPKRG')]",                      
            "dependsOn": [
                "Deploy-Hub-VirtualNetwork",
                "Deploy-Spoke-VirtualNetwork"
            ],            
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/peeringrg.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "VirtualNetworkPeeringAPIVersion": {
                        "value": "[variables('VirtualNetworkPeeringAPIVersion')]"
                    },                                        
                    "SourceVNetName": {
                        "value": "[variables('SPKVNetName')]"
                    },
                    "TargetVNetName": {
                        "value": "[variables('HUBVNetName')]"
                    },              
                    "TargetVNetRG": {
                        "value": "[parameters('HUBRG')]"
                    },                            
                    "allowVirtualNetworkAccess": {
                        "value": "true"
                    },                                                                                                                                                                                                                                                                                                           
                    "allowForwardedTraffic": {
                        "value": "true"
                    },                                                                                                                                                                                                                                                                                                           
                    "allowGatewayTransit": {
                        "value": "false"
                    },
                    "useRemoteGateways": {
                        "value": "false"
                    }
                }
            }
        },                                                  
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploying-Peering-On-Hub-for-Site1",
            "resourceGroup":  "[parameters('HUBRG')]",                      
            "dependsOn": [
                "Deploy-Hub-VirtualNetwork",
                "Deploy-Site1-VirtualNetwork"
            ],            
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/peeringrg.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "VirtualNetworkPeeringAPIVersion": {
                        "value": "[variables('VirtualNetworkPeeringAPIVersion')]"
                    },                    
                    "SourceVNetName": {
                        "value": "[variables('HUBVNetName')]"
                    },
                    "TargetVNetName": {
                        "value": "[variables('SITE1VNetName')]"
                    },              
                    "TargetVNetRG": {
                        "value": "[parameters('SITE1RG')]"
                    },                            
                    "allowVirtualNetworkAccess": {
                        "value": "true"
                    },                                                                                                                                                                                                                                                                                                           
                    "allowForwardedTraffic": {
                        "value": "true"
                    },                                                                                                                                                                                                                                                                                                           
                    "allowGatewayTransit": {
                        "value": "false"
                    },
                    "useRemoteGateways": {
                        "value": "false"
                    }
                }
            }
        },            
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploying-Peering-On-Site1-for-Hub",
            "resourceGroup":  "[parameters('SITE1RG')]",                      
            "dependsOn": [
                "Deploy-Hub-VirtualNetwork",
                "Deploy-Site1-VirtualNetwork"
            ],            
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/peeringrg.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "VirtualNetworkPeeringAPIVersion": {
                        "value": "[variables('VirtualNetworkPeeringAPIVersion')]"
                    },                                        
                    "SourceVNetName": {
                        "value": "[variables('SITE1VNetName')]"
                    },
                    "TargetVNetName": {
                        "value": "[variables('HUBVNetName')]"
                    },              
                    "TargetVNetRG": {
                        "value": "[parameters('HUBRG')]"
                    },                            
                    "allowVirtualNetworkAccess": {
                        "value": "true"
                    },                                                                                                                                                                                                                                                                                                           
                    "allowForwardedTraffic": {
                        "value": "true"
                    },                                                                                                                                                                                                                                                                                                           
                    "allowGatewayTransit": {
                        "value": "false"
                    },
                    "useRemoteGateways": {
                        "value": "false"
                    }
                }
            }
        },                                                  
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploying-Peering-On-Hub-for-Site2",
            "resourceGroup":  "[parameters('HUBRG')]",                      
            "dependsOn": [
                "Deploy-Hub-VirtualNetwork",
                "Deploy-Site2-VirtualNetwork"
            ],            
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/peeringrg.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "VirtualNetworkPeeringAPIVersion": {
                        "value": "[variables('VirtualNetworkPeeringAPIVersion')]"
                    },                    
                    "SourceVNetName": {
                        "value": "[variables('HUBVNetName')]"
                    },
                    "TargetVNetName": {
                        "value": "[variables('SITE2VNetName')]"
                    },              
                    "TargetVNetRG": {
                        "value": "[parameters('SITE2RG')]"
                    },                            
                    "allowVirtualNetworkAccess": {
                        "value": "true"
                    },                                                                                                                                                                                                                                                                                                           
                    "allowForwardedTraffic": {
                        "value": "true"
                    },                                                                                                                                                                                                                                                                                                           
                    "allowGatewayTransit": {
                        "value": "false"
                    },
                    "useRemoteGateways": {
                        "value": "false"
                    }
                }
            }
        },            
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploying-Peering-On-Site2-for-Hub",
            "resourceGroup":  "[parameters('SITE2RG')]",                      
            "dependsOn": [
                "Deploy-Hub-VirtualNetwork",
                "Deploy-Site2-VirtualNetwork"
            ],            
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/peeringrg.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "VirtualNetworkPeeringAPIVersion": {
                        "value": "[variables('VirtualNetworkPeeringAPIVersion')]"
                    },                                        
                    "SourceVNetName": {
                        "value": "[variables('SITE2VNetName')]"
                    },
                    "TargetVNetName": {
                        "value": "[variables('HUBVNetName')]"
                    },              
                    "TargetVNetRG": {
                        "value": "[parameters('HUBRG')]"
                    },                            
                    "allowVirtualNetworkAccess": {
                        "value": "true"
                    },                                                                                                                                                                                                                                                                                                           
                    "allowForwardedTraffic": {
                        "value": "true"
                    },                                                                                                                                                                                                                                                                                                           
                    "allowGatewayTransit": {
                        "value": "false"
                    },
                    "useRemoteGateways": {
                        "value": "false"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-Windows-RRAS-Network-Virtual-Appliance",
            "resourceGroup":  "[parameters('HUBRG')]",         
            "dependsOn": [
                "Deploy-Hub-VirtualNetwork"
            ],      
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/2nics-1disk-nva.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "NetworkInterfacesAPIVersion": {
                        "value": "[variables('NetworkInterfacesAPIVersion')]"
                    },
                    "VirtualMachinesAPIVersion": {
                        "value": "[variables('VirtualMachinesAPIVersion')]"
                    },
                    "SchedulesAPIVersion": {
                        "value": "[variables('SchedulesAPIVersion')]"
                    },                    
                    "computerName": {
                        "value": "[variables('NVAVMName')]"
                    },
                    "OutsideIP": {
                        "value": "[variables('NVA-Outside-IP')]"
                    },
                    "InsideIP": {
                        "value": "[variables('NVA-Inside-IP')]"
                    },              
                    "Publisher": {
                        "value": "MicrosoftWindowsServer"
                    },
                    "Offer": {
                        "value": "WindowsServer"
                    },
                    "OSSku": {
                        "value": "[parameters('NVAVMOSSku')]"
                    },                
                    "OSVersion": {
                        "value": "[parameters('NVAVMOSVersion')]"
                    },              
                    "LicenseType": {
                        "value": "[parameters('WindowsServerLicenseType')]"
                    },            
                    "VMSize": {
                        "value": "[parameters('NVAVMSize')]"
                    },
                    "vnetName": {
                        "value": "[variables('HUBVNetName')]"
                    },            
                    "subnet1Name": {
                        "value": "[variables('HUBVNetSubnet1Name')]"
                    },      
                    "subnet2Name": {
                        "value": "[variables('HUBVNetSubnet2Name')]"
                    },                                                                                                                                 
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },                                                                                                            
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "TimeZone": {
                        "value": "[parameters('TimeZone')]"
                    },  
                    "AutoShutdownEnabled": {
                        "value": "[parameters('AutoShutdownEnabled')]"
                    },                                                       
                    "AutoShutdownTime": {
                        "value": "[parameters('AutoShutdownTime')]"
                    },              
                    "AutoShutdownEmail": {
                        "value": "[parameters('AutoShutdownEmail')]"
                    }                                                                                                                                                                                                                                                                                                                          
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Install-and-Configure-RRAS",
            "resourceGroup":  "[parameters('HUBRG')]",
            "dependsOn": [
                "Deploy-Windows-RRAS-Network-Virtual-Appliance"             
            ],              
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/rras.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },                    
                    "computerName": {
                        "value": "[variables('NVAVMName')]"
                    },
                    "Site1NextHop": {
                        "value": "[variables('Site1NextHop')]"
                    },              
                    "Site2NextHop": {
                        "value": "[variables('Site2NextHop')]"
                    },                            
                    "SpokeNextHop": {
                        "value": "[variables('SpokeNextHop')]"
                    },                             
                    "OutsideSubnetPrefix": {
                        "value": "[variables('OutsideSubnetPrefix')]"
                    },                                             
                    "InsideSubnetPrefix": {
                        "value": "[variables('InsideSubnetPrefix')]"
                    },                              
                    "Site1VNet": {
                        "value": "[variables('SITE1VNetPrefix')]"
                    },          
                    "Site2VNet": {
                        "value": "[variables('SITE2VNetPrefix')]"
                    },  
                    "SpokeVNet": {
                        "value": "[variables('SPKVNetPrefix')]"
                    },                                                                                                                              
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },                                                                                                            
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Restart-Windows-RRAS-Server_01",
            "resourceGroup":  "[parameters('HUBRG')]",            
            "dependsOn": [
                "Install-and-Configure-RRAS"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/restartvm2.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('NVAVMName')]"
                    },
                    "Identifier": {
                        "value": "[concat(variables('Identifier'),'-1')]"
                    },                    
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Configure-Routing-Only",
            "resourceGroup":  "[parameters('HUBRG')]",            
            "dependsOn": [
                "Restart-Windows-RRAS-Server_01"
            ],            
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/routingonly.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },                    
                    "computerName": {
                        "value": "[variables('NVAVMName')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },                                                                                                            
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    }, 
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },                                                                                                            
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }                                                                                                                                                                                                                                                                                                           
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Create-Hub-RouteTable",
            "resourceGroup":  "[parameters('HUBRG')]",
            "dependsOn": [
                "Deploy-Hub-VirtualNetwork"          
            ],              
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/hubspokeroutetable.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "RouteTableAPIVersion": {
                        "value": "[variables('RouteTableAPIVersion')]"
                    },                    
                    "Name": {
                        "value": "[variables('HUBRouteTableName')]"
                    },
                    "Site1Name": {
                        "value": "Site1"
                    },                    
                    "Site1Prefix": {
                        "value": "[variables('SITE1VNetPrefix')]"
                    },           
                    "Site2Name": {
                        "value": "Site2"
                    },                                             
                    "Site2Prefix": {
                        "value": "[variables('SITE2VNetPrefix')]"
                    },                         
                    "RemoteGatewayIP": {
                        "value": "[variables('NVA-Inside-IP')]"
                    }
                }
            }
        }, 
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Create-Spoke-RouteTable",
            "resourceGroup":  "[parameters('SPKRG')]",
            "dependsOn": [
                "Deploy-Spoke-VirtualNetwork"          
            ],              
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/hubspokeroutetable.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "RouteTableAPIVersion": {
                        "value": "[variables('RouteTableAPIVersion')]"
                    },                                       
                    "Name": {
                        "value": "[variables('SPKRouteTableName')]"
                    },
                    "Site1Name": {
                        "value": "Site1"
                    },                     
                    "Site1Prefix": {
                        "value": "[variables('SITE1VNetPrefix')]"
                    },    
                    "Site2Name": {
                        "value": "Site2"
                    },                            
                    "Site2Prefix": {
                        "value": "[variables('SITE2VNetPrefix')]"
                    },                         
                    "RemoteGatewayIP": {
                        "value": "[variables('NVA-Inside-IP')]"
                    }
                }
            }
        },   
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Create-Site1-RouteTable",
            "resourceGroup":  "[parameters('SITE1RG')]",
            "dependsOn": [
                "Deploy-Site1-VirtualNetwork"          
            ],              
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/siteroutetable.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "RouteTableAPIVersion": {
                        "value": "[variables('RouteTableAPIVersion')]"
                    },                                       
                    "Name": {
                        "value": "[variables('SITE1RouteTableName')]"
                    },
                    "SiteName": {
                        "value": "Site2"
                    },                         
                    "SitePrefix": {
                        "value": "[variables('SITE2VNetPrefix')]"
                    },           
                    "SpokePrefix": {
                        "value": "[variables('SPKVNetPrefix')]"
                    },                         
                    "RemoteGatewayIP": {
                        "value": "[variables('NVA-Outside-IP')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Create-Site2-RouteTable",
            "resourceGroup":  "[parameters('SITE2RG')]",
            "dependsOn": [
                "Deploy-Site2-VirtualNetwork"          
            ],              
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/siteroutetable.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "RouteTableAPIVersion": {
                        "value": "[variables('RouteTableAPIVersion')]"
                    },                                       
                    "Name": {
                        "value": "[variables('SITE2RouteTableName')]"
                    },
                    "SiteName": {
                        "value": "Site2"
                    },                         
                    "SitePrefix": {
                        "value": "[variables('SITE1VNetPrefix')]"
                    },           
                    "SpokePrefix": {
                        "value": "[variables('SPKVNetPrefix')]"
                    },                         
                    "RemoteGatewayIP": {
                        "value": "[variables('NVA-Outside-IP')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Update-Hub-VirtualNetwork-RouteTable",
            "resourceGroup":  "[parameters('HUBRG')]",               
            "dependsOn": [
                "Create-Hub-RouteTable"
            ],            
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/updatehubvnetroutetable.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "VirtualNetworkAPIVersion": {
                        "value": "[variables('VirtualNetworkAPIVersion')]"
                    },
                    "vnetName": {
                        "value": "[variables('HUBVNetName')]"
                    },
                    "vnetprefix": {
                        "value": "[variables('HUBVNetPrefix')]"
                    },
                    "subnet1Name": {
                        "value": "[variables('HUBVNetsubnet1Name')]"
                    },
                    "subnet1Prefix": {
                        "value": "[variables('HUBVNetsubnet1Prefix')]"
                    },
                    "subnet2Name": {
                        "value": "[variables('HUBVNetsubnet2Name')]"
                    },
                    "subnet2Prefix": {
                        "value": "[variables('HUBVNetsubnet2Prefix')]"
                    },
                    "GatewaysubnetPrefix": {
                        "value": "[variables('HUBVNetGatewaysubnetPrefix')]"
                    },
                    "BastionsubnetPrefix": {
                        "value": "[variables('HUBVNetBastionsubnetPrefix')]"
                    },
                    "FirewallsubnetPrefix": {
                        "value": "[variables('HUBVNetFirewallsubnetPrefix')]"
                    },                         
                    "RouteTableName": {
                        "value": "[variables('HUBRouteTableName')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Update-Spoke-VirtualNetwork-RouteTable",
            "resourceGroup":  "[parameters('SPKRG')]",               
            "dependsOn": [
            "Create-Spoke-RouteTable"
            ],            
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/updatenonhubvnetroutetable.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "VirtualNetworkAPIVersion": {
                        "value": "[variables('VirtualNetworkAPIVersion')]"
                    },
                    "vnetName": {
                        "value": "[variables('SPKVNetName')]"
                    },
                    "vnetprefix": {
                        "value": "[variables('SPKVNetPrefix')]"
                    },
                    "subnet1Name": {
                        "value": "[variables('SPKVNetsubnet1Name')]"
                    },
                    "subnet1Prefix": {
                        "value": "[variables('SPKVNetsubnet1Prefix')]"
                    },
                    "subnet2Name": {
                        "value": "[variables('SPKVNetsubnet2Name')]"
                    },
                    "subnet2Prefix": {
                        "value": "[variables('SPKVNetsubnet2Prefix')]"
                    },
                    "GatewaysubnetPrefix": {
                        "value": "[variables('SPKVNetGatewaysubnetPrefix')]"
                    },
                    "BastionsubnetPrefix": {
                        "value": "[variables('SPKVNetBastionsubnetPrefix')]"
                    },
                    "FirewallsubnetPrefix": {
                        "value": "[variables('SPKVNetFirewallsubnetPrefix')]"
                    },
                    "RouteTableName": {
                        "value": "[variables('SPKRouteTableName')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Update-Site1-VirtualNetwork-RouteTable",
            "resourceGroup":  "[parameters('SITE1RG')]",               
            "dependsOn": [
            "Create-Site1-RouteTable"
            ],            
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/updatenonhubvnetroutetable.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "VirtualNetworkAPIVersion": {
                        "value": "[variables('VirtualNetworkAPIVersion')]"
                    },
                    "vnetName": {
                        "value": "[variables('SITE1VNetName')]"
                    },
                    "vnetprefix": {
                        "value": "[variables('SITE1VNetPrefix')]"
                    },
                    "subnet1Name": {
                        "value": "[variables('SITE1VNetsubnet1Name')]"
                    },
                    "subnet1Prefix": {
                        "value": "[variables('SITE1VNetsubnet1Prefix')]"
                    },
                    "subnet2Name": {
                        "value": "[variables('SITE1VNetsubnet2Name')]"
                    },
                    "subnet2Prefix": {
                        "value": "[variables('SITE1VNetsubnet2Prefix')]"
                    },
                    "GatewaysubnetPrefix": {
                        "value": "[variables('SITE1VNetGatewaysubnetPrefix')]"
                    },
                    "BastionsubnetPrefix": {
                        "value": "[variables('SITE1VNetBastionsubnetPrefix')]"
                    },
                    "FirewallsubnetPrefix": {
                        "value": "[variables('SITE1VNetFirewallsubnetPrefix')]"
                    },
                    "RouteTableName": {
                        "value": "[variables('SITE1RouteTableName')]"
                    }                                                                                                                                                                                                                              
                }
            }
        },   
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Update-Site2-VirtualNetwork-RouteTable",
            "resourceGroup":  "[parameters('SITE2RG')]",               
            "dependsOn": [
                "Create-Site2-RouteTable"
            ],            
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/updatenonhubvnetroutetable.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "VirtualNetworkAPIVersion": {
                        "value": "[variables('VirtualNetworkAPIVersion')]"
                    },
                    "vnetName": {
                        "value": "[variables('SITE2VNetName')]"
                    },
                    "vnetprefix": {
                        "value": "[variables('SITE2VNetPrefix')]"
                    },
                    "subnet1Name": {
                        "value": "[variables('SITE2VNetsubnet1Name')]"
                    },
                    "subnet1Prefix": {
                        "value": "[variables('SITE2VNetsubnet1Prefix')]"
                    },
                    "subnet2Name": {
                        "value": "[variables('SITE2VNetsubnet2Name')]"
                    },
                    "subnet2Prefix": {
                        "value": "[variables('SITE2VNetsubnet2Prefix')]"
                    },
                    "GatewaysubnetPrefix": {
                        "value": "[variables('SITE2VNetGatewaysubnetPrefix')]"
                    },
                    "BastionsubnetPrefix": {
                        "value": "[variables('SITE2VNetBastionsubnetPrefix')]"
                    },
                    "FirewallsubnetPrefix": {
                        "value": "[variables('SITE2VNetFirewallsubnetPrefix')]"
                    },
                    "RouteTableName": {
                        "value": "[variables('SITE2RouteTableName')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-Hub-VirtualMachine",
            "resourceGroup":   "[parameters('HUBRG')]",                              
            "dependsOn": [
                "Deploy-Hub-VirtualNetwork"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/1nic-1disk-vm.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "NetworkInterfacesAPIVersion": {
                        "value": "[variables('NetworkInterfacesAPIVersion')]"
                    },
                    "VirtualMachinesAPIVersion": {
                        "value": "[variables('VirtualMachinesAPIVersion')]"
                    },
                    "SchedulesAPIVersion": {
                        "value": "[variables('SchedulesAPIVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('hubvmname')]"
                    },
                    "computerIP": {
                        "value": "[variables('hubvmIP')]"
                    },
                    "Publisher": {
                        "value": "MicrosoftWindowsServer"
                    },
                    "Offer": {
                        "value": "WindowsServer"
                    },
                    "OSSku": {
                        "value": "[parameters('HUBVMOSSku')]"
                    },
                    "OSVersion": {
                        "value": "[parameters('HUBVMOSVersion')]"
                    },
                    "LicenseType": {
                        "value": "[parameters('WindowsServerLicenseType')]"
                    },
                    "VMSize": {
                        "value": "[parameters('HUBVMSize')]"
                    },
                    "vnetName": {
                        "value": "[variables('HUBVNetName')]"
                    },
                    "subnet1Name": {
                        "value": "[variables('HUBVNetSubnet2Name')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "TimeZone": {
                        "value": "[parameters('TimeZone')]"
                    },
                    "AutoShutdownEnabled": {
                        "value": "[parameters('AutoShutdownEnabled')]"
                    },
                    "AutoShutdownTime": {
                        "value": "[parameters('AutoShutdownTime')]"
                    },
                    "AutoShutdownEmail": {
                        "value": "[parameters('AutoShutdownEmail')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-SQLServer-01",
            "resourceGroup":   "[parameters('SPKRG')]",                                          
            "dependsOn": [
                "Deploy-Spoke-VirtualNetwork"
            ],            
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/1nic-3disk-vm.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "NetworkInterfacesAPIVersion": {
                        "value": "[variables('NetworkInterfacesAPIVersion')]"
                    },
                    "VirtualMachinesAPIVersion": {
                        "value": "[variables('VirtualMachinesAPIVersion')]"
                    },
                    "SchedulesAPIVersion": {
                        "value": "[variables('SchedulesAPIVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('SQLVMName')]"
                    },
                    "computerIP": {
                        "value":  "[variables('SQLVMIP')]"
                    },
                    "Publisher": {
                        "value": "MicrosoftWindowsServer"
                    },
                    "Offer": {
                        "value": "WindowsServer"
                    },
                    "OSSku": {
                        "value":  "[parameters('SQLVMOSSku')]"
                    },
                    "OSVersion": {
                        "value": "[parameters('SQLVMOSVersion')]"
                    },
                    "LicenseType": {
                        "value": "[parameters('WindowsServerLicenseType')]"
                    },
                    "DataDisk1Name": {
                        "value": "SQLDatabases"
                    },            
                    "DataDisk2Name": {
                        "value": "SQLLogs"
                    },                     
                    "VMSize": {
                        "value": "[parameters('SQLVMSize')]"
                    },
                    "vnetName": {
                        "value": "[variables('SPKVNetName')]"
                    },
                    "subnet1Name": {
                        "value": "[variables('SPKVNetSubnet1Name')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "TimeZone": {
                        "value": "[parameters('TimeZone')]"
                    },
                    "AutoShutdownEnabled": {
                        "value": "[parameters('AutoShutdownEnabled')]"
                    },
                    "AutoShutdownTime": {
                        "value": "[parameters('AutoShutdownTime')]"
                    },
                    "AutoShutdownEmail": {
                        "value": "[parameters('AutoShutdownEmail')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "resourceGroup":   "[parameters('SPKRG')]",            
            "name": "Install-SQLServer",
            "dependsOn": [
                "Deploy-SQLServer-01"
            ],      
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/sql.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },                    
                    "computerName": {
                        "value": "[variables('SQLVMName')]"
                    },
                    "SQLSASUrl": {
                        "value": "[parameters('SQLSASUrl')]"
                    },                                                                     
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },                                                                                                            
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },                                                                                                            
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Enable-SQL-WindowsFirewall-Port-on-SQLVM",
            "resourceGroup":   "[parameters('SPKRG')]",            
            "dependsOn": [
               "Install-SQLServer"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/windowsfirewallport.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('SQLVMName')]"
                    },
                    "FirewallRuleName": {
                        "value": "Enable-SQL-Management-Studio-Inbound"
                    },    
                    "Direction": {
                        "value": "Inbound"
                    },                        
                    "Port": {
                        "value": "1433"
                    },
                    "Protocol": {
                        "value": "TCP"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },                                                                                                                           
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }
                }
            }
        },                         
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-Site1-VirtualMachine",
            "resourceGroup":   "[parameters('SITE1RG')]",                              
            "dependsOn": [
                "Deploy-Site1-VirtualNetwork"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/1nic-1disk-vm.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "NetworkInterfacesAPIVersion": {
                        "value": "[variables('NetworkInterfacesAPIVersion')]"
                    },
                    "VirtualMachinesAPIVersion": {
                        "value": "[variables('VirtualMachinesAPIVersion')]"
                    },
                    "SchedulesAPIVersion": {
                        "value": "[variables('SchedulesAPIVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('site1vmname')]"
                    },
                    "computerIP": {
                        "value": "[variables('site1vmIP')]"
                    },
                    "Publisher": {
                        "value": "MicrosoftWindowsServer"
                    },
                    "Offer": {
                        "value": "WindowsServer"
                    },
                    "OSSku": {
                        "value": "[parameters('SITE1VMOSSku')]"
                    },
                    "OSVersion": {
                        "value": "[parameters('SITE1VMOSVersion')]"
                    },
                    "LicenseType": {
                        "value": "[parameters('WindowsServerLicenseType')]"
                    },
                    "VMSize": {
                        "value": "[parameters('SITE1VMSize')]"
                    },
                    "vnetName": {
                        "value": "[variables('SITE1VNetName')]"
                    },
                    "subnet1Name": {
                        "value": "[variables('SITE1VNetSubnet1Name')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "TimeZone": {
                        "value": "[parameters('TimeZone')]"
                    },
                    "AutoShutdownEnabled": {
                        "value": "[parameters('AutoShutdownEnabled')]"
                    },
                    "AutoShutdownTime": {
                        "value": "[parameters('AutoShutdownTime')]"
                    },
                    "AutoShutdownEmail": {
                        "value": "[parameters('AutoShutdownEmail')]"
                    }
                }
            }
        }, 
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Install-SQL-Management-Studio-on-Site1VM",
            "resourceGroup":   "[parameters('SITE1RG')]",            
            "dependsOn": [
               "Deploy-Site1-VirtualMachine"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/ssms.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('SITE1VMName')]"
                    },
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Enable-SQL-WindowsFirewall-Port-on-Site1VM",
            "resourceGroup":   "[parameters('SITE1RG')]",            
            "dependsOn": [
               "Install-SQL-Management-Studio-on-Site1VM"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/windowsfirewallport.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('SITE1VMName')]"
                    },
                    "FirewallRuleName": {
                        "value": "Enable-SQL-Management-Studio-Outbound"
                    },    
                    "Direction": {
                        "value": "Outbound"
                    },                        
                    "Port": {
                        "value": "1433"
                    },
                    "Protocol": {
                        "value": "TCP"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },                                                                                                                           
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }
                }
            }
        },        
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Deploy-Site2-VirtualMachine",
            "resourceGroup":   "[parameters('SITE2RG')]",                              
            "dependsOn": [
                "Deploy-Site2-VirtualNetwork"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/1nic-1disk-vm.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "NetworkInterfacesAPIVersion": {
                        "value": "[variables('NetworkInterfacesAPIVersion')]"
                    },
                    "VirtualMachinesAPIVersion": {
                        "value": "[variables('VirtualMachinesAPIVersion')]"
                    },
                    "SchedulesAPIVersion": {
                        "value": "[variables('SchedulesAPIVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('site2vmname')]"
                    },
                    "computerIP": {
                        "value": "[variables('site2vmIP')]"
                    },
                    "Publisher": {
                        "value": "MicrosoftWindowsServer"
                    },
                    "Offer": {
                        "value": "WindowsServer"
                    },
                    "OSSku": {
                        "value": "[parameters('SITE2VMOSSku')]"
                    },
                    "OSVersion": {
                        "value": "[parameters('SITE2VMOSVersion')]"
                    },
                    "LicenseType": {
                        "value": "[parameters('WindowsServerLicenseType')]"
                    },
                    "VMSize": {
                        "value": "[parameters('SITE2VMSize')]"
                    },
                    "vnetName": {
                        "value": "[variables('SITE2VNetName')]"
                    },
                    "subnet1Name": {
                        "value": "[variables('SITE2VNetSubnet1Name')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "TimeZone": {
                        "value": "[parameters('TimeZone')]"
                    },
                    "AutoShutdownEnabled": {
                        "value": "[parameters('AutoShutdownEnabled')]"
                    },
                    "AutoShutdownTime": {
                        "value": "[parameters('AutoShutdownTime')]"
                    },
                    "AutoShutdownEmail": {
                        "value": "[parameters('AutoShutdownEmail')]"
                    }
                }
            }
        }, 
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Install-SQL-Management-Studio-on-Site2VM",
            "resourceGroup":   "[parameters('SITE2RG')]",            
            "dependsOn": [
               "Deploy-Site2-VirtualMachine"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/ssms.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('SITE2VMName')]"
                    },
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "name": "Enable-SQL-WindowsFirewall-Port-on-Site2VM",
            "resourceGroup":   "[parameters('SITE2RG')]",            
            "dependsOn": [
               "Install-SQL-Management-Studio-on-Site2VM"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/windowsfirewallport.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "ExtensionsAPIVersion": {
                        "value": "[variables('ExtensionsAPIVersion')]"
                    },
                    "ExtensionsTypeHandlerVersion": {
                        "value": "[variables('ExtensionsTypeHandlerVersion')]"
                    },
                    "computerName": {
                        "value": "[variables('SITE2VMName')]"
                    },
                    "FirewallRuleName": {
                        "value": "Enable-SQL-Management-Studio-Outbound"
                    },    
                    "Direction": {
                        "value": "Outbound"
                    },                        
                    "Port": {
                        "value": "1433"
                    },
                    "Protocol": {
                        "value": "TCP"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },                                                                                                                           
                    "_artifactsLocation": {
                        "value": "[parameters('_artifactsLocation')]"
                    },
                    "_artifactsLocationSasToken": {
                        "value": "[parameters('_artifactsLocationSasToken')]"
                    }
                }
            }
        },                
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "resourceGroup":   "[parameters('HUBRG')]",             
            "name": "Deploy-PrivateDNSZone",
            "dependsOn": [
                "Deploy-Site1-VirtualNetwork",
                "Deploy-Site2-VirtualNetwork",
                "Deploying-Peering-On-Hub-for-Site1",
                "Deploying-Peering-On-Site1-for-Hub",                
                "Deploying-Peering-On-Hub-for-Site2",   
                "Deploying-Peering-On-Site2-for-Hub"
            ],            
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/privatednszone.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "PrivateDNSZoneAPIVersion": {
                        "value": "[variables('PrivateDNSZoneAPIVersion')]"
                    },                      
                    "ZoneName": {
                        "value": "domain.local"
                    }                                                                                                                                                                 
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "resourceGroup":   "[parameters('HUBRG')]",                         
            "name": "Create-PrivateDNSZone-SQL-ARecord",
            "dependsOn": [
                "Deploy-PrivateDNSZone"
            ],            
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/privatednszonea.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "PrivateDNSZoneAPIVersion": {
                        "value": "[variables('PrivateDNSZoneAPIVersion')]"
                    },                            
                    "ZoneName": {
                        "value": "domain.local"
                    },
                    "HostName": {
                        "value": "[variables('SQLVMName')]"
                    },
                    "IP": {
                        "value": "[variables('SQLVMIP')]"
                    }                                                                                                                                                                                                                                                                                                                         
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "resourceGroup":   "[parameters('HUBRG')]",             
            "name": "Deploy-PrivateDNSZone-Link-for-Site1",
            "dependsOn": [
                "Create-PrivateDNSZone-SQL-ARecord"
            ],            
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/privatednszonelinkrg.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "PrivateDNSZoneAPIVersion": {
                        "value": "[variables('PrivateDNSZoneAPIVersion')]"
                    },                      
                    "ZoneName": {
                        "value": "domain.local"
                    },
                    "vnetName": {
                        "value": "[variables('SITE1VNetName')]"
                    },    
                    "vnetRG": {
                        "value": "[parameters('SITE1RG')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "[variables('DeploymentAPIVersion')]",
            "resourceGroup":   "[parameters('HUBRG')]",             
            "name": "Deploy-PrivateDNSZone-Link-for-Site2",
            "dependsOn": [
                "Deploy-PrivateDNSZone-Link-for-Site1"
            ],            
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), concat('templates/privatednszonelinkrg.json', parameters('_artifactsLocationSasToken')))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "PrivateDNSZoneAPIVersion": {
                        "value": "[variables('PrivateDNSZoneAPIVersion')]"
                    },                      
                    "ZoneName": {
                        "value": "domain.local"
                    },
                    "vnetName": {
                        "value": "[variables('SITE2VNetName')]"
                    },    
                    "vnetRG": {
                        "value": "[parameters('SITE2RG')]"
                    }
                }
            }
        }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
    ]
}